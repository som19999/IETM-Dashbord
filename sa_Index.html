<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IETM Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        body {
            font-family: "Inter", sans-serif;
        }

        /* Base styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe;
            /* Light blue background for a fresh look */
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Custom scrollbar for content areas */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #90cdf4;
            /* Tailwind blue-300 */
            border-radius: 10px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #63b3ed;
            /* Tailwind blue-400 */
        }

        /* Styling for the expand/collapse arrow */
        .module-toggle-arrow {
            transition: transform 0.2s ease-in-out;
            color: #4a5568;
            /* Gray-700 for the arrow */
        }

        .module-toggle-arrow.expanded {
            transform: rotate(90deg);
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            /* Subtle blur effect */
        }

        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            /* Increased padding */
            border-radius: 1rem;
            /* More rounded corners */
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
            /* Stronger shadow */
            width: 90%;
            max-width: 550px;
            /* Slightly wider */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            /* Add entry animation */
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.8rem;
            /* Larger close button */
            cursor: pointer;
            color: #9ca3af;
            /* Lighter gray for close button */
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: #ef4444;
            /* Red on hover */
        }

        /* Animation for modal entry */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Custom styles for rendered XML output to match overall theme */
        .rendered-xml h2 {
            font-size: 1.875rem;
            /* text-3xl for main headings */
            font-weight: 700;
            /* font-bold */
            margin-bottom: 0.75rem;
            /* mb-3 */
            color: #1a202c;
            /* gray-900 */
        }

        .rendered-xml h3 {
            font-size: 1.5rem;
            /* text-2xl */
            font-weight: 600;
            /* font-semibold */
            margin-bottom: 0.75rem;
            /* mb-3 */
            color: #2d3748;
            /* gray-800 */
        }

        .rendered-xml p {
            margin-bottom: 1.25rem;
            /* mb-5 */
            line-height: 1.6;
            /* Improved readability */
            color: #4a5568;
            /* gray-700 */
        }

        .rendered-xml strong {
            font-weight: 700;
            /* font-bold */
            color: #2d3748;
            /* Darker gray for emphasis */
        }

        .rendered-xml em {
            font-style: italic;
            color: #4a5568;
        }

        .rendered-xml ul,
        .rendered-xml ol {
            margin-bottom: 1.25rem;
            /* mb-5 */
            padding-left: 1.75rem;
            /* For list-inside */
        }

        .rendered-xml ul {
            list-style-type: disc;
        }

        .rendered-xml ol {
            list-style-type: decimal;
        }

        .rendered-xml li {
            margin-bottom: 0.6rem;
            /* mb-2.5 */
            color: #4a5568;
        }

        .rendered-xml table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            /* mb-6 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            /* subtle shadow for tables */
            border-radius: 0.5rem;
            /* rounded table corners */
            overflow: hidden;
            /* Ensures rounded corners clip content */
        }

        .rendered-xml th,
        .rendered-xml td {
            border: 1px solid #e2e8f0;
            /* border-gray-300 */
            padding: 0.8rem 1rem;
            /* Increased padding */
            text-align: left;
            font-size: 0.95rem;
        }

        .rendered-xml thead tr {
            background-color: #e2e8f0;
            /* bg-gray-200 for table header */
            color: #2d3748;
            /* Darker text for header */
            font-weight: 600;
        }

        .rendered-xml tbody tr:nth-child(odd) {
            background-color: #f7fafc;
            /* zebra striping */
        }

        .rendered-xml tbody tr:hover {
            background-color: #ebf4ff;
            /* light blue hover */
        }

        .rendered-xml .note-caution {
            background-color: #fff8e1;
            /* bg-yellow-50 light */
            border-left: 5px solid #f6ad55;
            /* border-yellow-500 */
            color: #9c5d10;
            /* text-yellow-800 darker */
            padding: 1.25rem;
            /* p-5 */
            border-radius: 0.5rem;
            /* rounded-lg */
            margin-bottom: 1.5rem;
            /* mb-6 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .rendered-xml .note-warning {
            background-color: #ffeaea;
            /* bg-red-50 light */
            border-left: 5px solid #ef4444;
            /* border-red-500 */
            color: #991b1b;
            /* text-red-800 darker */
            padding: 1.25rem;
            /* p-5 */
            border-radius: 0.5rem;
            /* rounded-lg */
            margin-bottom: 1.5rem;
            /* mb-6 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .rendered-xml img {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            /* More rounded image corners */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            /* Stronger image shadow */
            margin-bottom: 1.5rem;
            /* mb-6 */
            display: block;
            /* Ensure images are block-level for centering */
            margin-left: auto;
            margin-right: auto;
        }

        .rendered-xml .hotspot-link {
            color: #2563eb;
            /* text-blue-600 for links */
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .rendered-xml .hotspot-link:hover {
            color: #1e40af;
            /* Darker blue on hover */
        }

        /* Specific styling for rendered hotspots in user view */
        .rendered-hotspot {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.2);
            /* Semi-transparent blue */
            border: 1px solid rgba(0, 123, 255, 0.6);
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
            border-radius: 0.25rem;
        }

        .rendered-hotspot:hover {
            background-color: rgba(0, 123, 255, 0.4);
        }

        /* Annotated text highlight */
        .annotated-text {
            background-color: #fffacd;
            /* light yellow */
            cursor: help;
            /* change cursor on hover */
            border-bottom: 1px dashed #f0e68c;
            /* subtle dashed underline */
            position: relative;
            /* needed for tooltip positioning */
            display: inline-block;
            /* to wrap properly */
        }

        /* Tooltip for annotations */
        .annotation-tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 9999;
            /* ensure it's on top */
            bottom: 125%;
            /* Position above the text */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            white-space: normal;
            /* allow text to wrap */
            min-width: 200px;
            max-width: 300px;
            font-size: 0.875rem;
            /* text-sm */
            line-height: 1.4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .annotation-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .annotated-text:hover .annotation-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Style for annotator and timestamp in tooltip */
        .annotation-tooltip-meta {
            display: block;
            font-size: 0.75rem;
            /* text-xs */
            color: #ccc;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .annotation-tooltip-delete {
            background: none;
            border: none;
            color: #ef4444;
            /* red */
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
            padding: 0;
            float: right;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .annotation-tooltip-delete:hover {
            color: #dc2626;
            /* darker red */
        }


        /* Hierarchy lines and folder icons */
        .folder-icon-color {
            color: #f59e0b;
            /* Tailwind yellow-500 */
        }

        /* For the overall list item, to allow relative positioning of lines */
        .list-item-container {
            position: relative;
            margin-bottom: 0.125rem;
            /* Reduced vertical spacing: mb-0.5 (2px) for very less gap */
        }

        /* Vertical dotted line for children items */
        .vertical-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            border-left: 1px dotted #a0aec0;
            /* Tailwind gray-400 */
            z-index: 0;
        }

        /* Horizontal dotted line connecting to the item */
        .horizontal-line {
            position: absolute;
            top: 50%;
            height: 1px;
            border-top: 1px dotted #a0aec0;
            /* Tailwind gray-400 */
            z-index: 1;
            transform: translateY(-50%);
        }

        /* Module Button (entire clickable area) */
        .module-button {
            padding: 0.75rem 1rem;
            /* Adjusted padding for a softer feel */
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            position: relative;
            z-index: 2;
            border-radius: 0.625rem;
            /* Consistent rounding */
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            /* default transparent border */
        }

        .module-button.active {
            background-color: #e0f2fe;
            /* Light blue background for active */
            color: #1d4ed8;
            /* Darker blue text for active state */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            /* Subtle shadow for active */
            border-color: #90cdf4;
            /* Blue-300 border for active */
        }

        /* Hover state for the entire button (subtle) */
        .module-button:hover:not(.active) {
            background-color: transparent;
            /* No background change on hover for the button itself */
            border-color: transparent;
            /* Changed to transparent */
            box-shadow: none;
            /* Changed to none */
        }

        /* Text container and its elements within the button */
        .module-button .text-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            /* Allow wrapping for full topic name */
            transition: color 0.2s ease;
            /* Add transition for color */
        }

        /* Hover state for the text elements inside the button (more pronounced color change) */
        .module-button:hover:not(.active) .module-title,
        .module-button:hover:not(.active) .serial-prefix,
        .module-button:hover:not(.active) .function-topic-name {
            color: #2563eb;
            /* Blue-600 for text on hover (when not active) */
        }

        /* Active state text colors - ensure they inherit the button's active color */
        .module-button.active .serial-prefix,
        .module-button.active .module-title {
            color: inherit;
            /* Inherit the text color set by .active */
        }

        .module-button.active .function-topic-name {
            color: #6b7280;
            /* Keep subtle for active state */
        }

        .module-button .serial-prefix {
            font-weight: 300;
            color: #6b7280;
            /* Default gray */
            margin-right: 0.3rem;
            white-space: nowrap;
            /* Keep serial number on one line */
            text-shadow: none;
            /* Removed text shadow */
        }

        .module-button .module-title {
            font-weight: 500;
            text-shadow: none;
            /* Removed text shadow */
        }

        .module-button .function-topic-name {
            font-size: 0.75rem;
            color: #6b7280;
            /* Default gray for function topic name */
            margin-left: 0.5rem;
            white-space: nowrap;
            text-shadow: none;
            /* Removed text shadow */
        }


        /* Admin actions visibility */
        .module-button .admin-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            margin-left: 1.25rem;
            /* Increased margin */
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.2s ease;
        }

        .module-button:hover .admin-actions,
        .module-button.active .admin-actions {
            opacity: 1;
            /* Visible on hover or when active */
        }

        .module-button .admin-actions button {
            background: none;
            border: none;
            padding: 0.35rem;
            /* Slightly larger clickable area */
            border-radius: 0.375rem;
            /* Rounded button */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            color: #9ca3af;
            /* Default gray for admin buttons */
        }

        .module-button .admin-actions button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            /* Light hover for admin buttons */
            color: #3b82f6;
            /* Blue on hover */
        }

        .module-button.active .admin-actions button {
            color: #9ca3af;
            /* Keep default gray when parent is active and transparent */
        }

        .module-button.active .admin-actions button:hover {
            background-color: #e0f2fe;
            /* Light blue on hover even if active */
            color: #2563eb;
            /* Darker blue on hover */
        }


        /* Image container and download button within content */
        .image-container {
            position: relative;
            display: block;
            /* Images are block-level for centering */
            margin-left: auto;
            margin-right: auto;
            max-width: 100%;
            /* Ensure it respects parent width */
            height: auto;
            overflow: hidden;
            /* To clip rounded corners */
            border-radius: 0.75rem;
            /* Matches img radius */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            /* Stronger image shadow */
            margin-bottom: 1.5rem;
            /* mb-6 */
            background-color: #f0f0f0;
            /* Placeholder background while loading */
        }

        .image-download-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            /* Semi-transparent black */
            color: white;
            padding: 6px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
            /* Ensure it's above the image */
        }

        .image-container:hover .image-download-btn {
            opacity: 1;
        }

        .image-download-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Message Box styles (for custom alerts/confirms) */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            /* Higher than other modals */
            backdrop-filter: blur(2px);
        }

        .message-box {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.2s ease-out;
        }

        .message-box p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
            color: #374151;
        }

        .message-box-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .message-box-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .message-box .confirm-btn {
            background-color: #ef4444;
            /* red-500 */
            color: white;
        }

        .message-box .confirm-btn:hover {
            background-color: #dc2626;
            /* red-600 */
            transform: translateY(-1px);
        }

        .message-box .cancel-btn {
            background-color: #d1d5db;
            /* gray-300 */
            color: #374151;
        }

        .message-box .cancel-btn:hover {
            background-color: #9ca3af;
            /* gray-400 */
            transform: translateY(-1px);
        }

        .message-box .alert-btn {
            background-color: #2563eb;
            /* blue-600 */
            color: white;
        }

        .message-box .alert-btn:hover {
            background-color: #1d4ed8;
            /* blue-700 */
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }


        /* --- Print specific styles (these will be injected into the print window) --- */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-family: 'Inter', sans-serif;
                background-color: #ffffff;
                /* Ensure white background for print */
                color: #000000;
                /* Ensure black text for print */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 11pt;
                /* Base font size for print */
            }

            .print-container {
                width: 100%;
                max-width: 210mm;
                /* A4 width */
                margin: 0 auto;
                padding: 20mm;
                /* A4 margins */
                box-sizing: border-box;
                /* Include padding in width */
            }

            /* Basic heading and paragraph styles for print */
            .print-container h1,
            .print-container h2,
            .print-container h3,
            .print-container h4,
            .print-container h5,
            .print-container h6 {
                color: #000000 !important;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                page-break-after: avoid;
                font-weight: bold;
            }

            .print-container h1 {
                font-size: 24pt;
            }

            .print-container h2 {
                font-size: 18pt;
            }

            .print-container h3 {
                font-size: 14pt;
            }

            p,
            ul,
            ol,
            table {
                margin-bottom: 1em;
                line-height: 1.4;
                page-break-inside: avoid;
            }

            strong {
                font-weight: bold;
            }

            em {
                font-style: italic;
            }

            ul,
            ol {
                padding-left: 2em;
            }

            li {
                margin-bottom: 0.5em;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1.5em;
                border: 1px solid #ccc;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 0.6em 0.8em;
                text-align: left;
            }

            thead tr {
                background-color: #f0f0f0 !important;
                color: #000000 !important;
            }

            tbody tr:nth-child(odd) {
                background-color: #f7fafc !important;
                /* zebra striping */
            }

            img {
                max-width: 95% !important;
                height: auto !important;
                display: block;
                margin: 1em auto;
                box-shadow: none !important;
                border: 1px solid #eee;
                page-break-inside: avoid;
                /* Keep image on one page */
            }

            .print-container .image-container {
                /* Hide the container, image style applies to img directly */
                box-shadow: none !important;
                margin-bottom: 0 !important;
                border-radius: 0 !important;
            }

            .print-container .image-download-btn,
            .print-container .rendered-hotspot {
                /* Hide download button and hotspots in print */
                display: none !important;
            }

            /* Notes in print */
            .note-caution,
            .note-warning {
                border: 1px solid #ccc;
                border-left: 5px solid;
                padding: 1em 1.2em;
                margin-bottom: 1.5em;
                page-break-inside: avoid;
                background-color: #f8f8f8 !important;
                color: #000000 !important;
                border-radius: 5px;
            }

            .note-caution {
                border-left-color: #f6ad55 !important;
            }

            .note-warning {
                border-left-color: #ef4444 !important;
            }

            /* Hotspot links should show their target ID in print */
            .hotspot-link {
                text-decoration: underline;
                /* Keep underline for print */
                color: #000000;
                /* Black text for print */
            }

            .hotspot-link::after {
                content: " (ID: " attr(data-hotspot) ")";
                font-size: 90%;
                color: #555;
                word-break: break-all;
            }

            /* Annotated text highlight - should be removed in print or just show as normal text */
            .annotated-text {
                background-color: transparent !important;
                border-bottom: none !important;
                cursor: default !important;
            }

            .annotation-tooltip {
                display: none !important;
                /* Hide tooltips in print */
            }

            /* Ensure no elements outside .print-container are visible */
            body>*:not(.print-container) {
                display: none !important;
            }
        }
    </style>
</head>

<body class="p-4 sm:p-6 lg:p-8 flex items-center justify-center min-h-screen">

    <!-- Main Application Container -->
    <div id="appContainer"
        class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden min-h-[calc(100vh-32px)] w-full flex flex-col hidden transition-all duration-300">

        <!-- Header -->
        <header
            class="flex flex-col sm:flex-row justify-between items-center bg-gradient-to-r from-blue-700 to-blue-900 text-white p-4 sm:p-6 shadow-lg z-10 rounded-t-xl">
            <h1 id="appTitle" class="text-3xl font-extrabold mb-2 sm:mb-0 text-shadow">IETM Viewer</h1>
            <div class="flex flex-wrap items-center space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                <!-- Page Navigation Buttons -->
                <nav class="flex items-center space-x-2">
                    <button id="backBtn"
                        class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg"
                        title="Go Back">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-arrow-left">
                            <path d="m12 19-7-7 7-7" />
                            <path d="M19 12H5" />
                        </svg>
                    </button>
                    <button id="forwardBtn"
                        class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg"
                        title="Go Forward">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-arrow-right">
                            <path d="M5 12h14" />
                            <path d="m12 5 7 7-7 7" />
                        </svg>
                    </button>
                    <button id="refreshBtn"
                        class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition duration-200 shadow-md hover:shadow-lg"
                        title="Refresh Page">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-refresh-ccw">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.76L3 7" />
                            <path d="M3 3v4h4" />
                            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.76L21 17" />
                            <path d="M21 21v-4h-4" />
                        </svg>
                    </button>
                </nav>

                <!-- Utility Buttons (Right Side) -->
                <div class="flex items-center space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                    <!-- Original Print Button -->
                    <button id="printBtn"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-lg text-sm transition duration-200 shadow-md hover:shadow-lg"
                        title="Print Current Page">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="inline-block mr-1 lucide lucide-printer">
                            <path d="M6 9V2h12v7" />
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                            <path d="M6 14H3v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4h-3" />
                            <path d="M14 14v7" />
                        </svg>
                        Print
                    </button>

                    <!-- Original Download Button (User-facing) -->
                    <button id="downloadBtn"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-lg text-sm transition duration-200 shadow-md hover:shadow-lg"
                        title="Download Current Page as HTML">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="inline-block mr-1 lucide lucide-download">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg>
                        Download
                    </button>

                    <!-- New Full History Button (Visible to all users) -->
                    <button id="fullHistoryBtn"
                        class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded-lg text-sm transition duration-200 shadow-md hover:shadow-lg"
                        title="View Full Project History">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="inline-block mr-1 lucide lucide-history">
                            <path d="M3 3v5h5" />
                            <path d="M3.05 13A9 9 0 1 0 6 18.35" />
                            <path d="M12 7v6h4" />
                        </svg>
                        Full History
                    </button>

                    <!-- Chat/Help/User Icons -->
                    <button id="chatBtn"
                        class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition duration-200 shadow-md hover:shadow-lg"
                        title="Open Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-message-circle">
                            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
                        </svg>
                    </button>
                    <button id="helpBtn"
                        class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition duration-200 shadow-md hover:shadow-lg"
                        title="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-help-circle">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                            <path d="M12 17h.01" />
                        </svg>
                    </button>

                    <!-- User Info & Logout -->
                    <span id="userInfo" class="text-blue-100 text-sm hidden sm:inline-block"></span>
                    <button id="logoutBtn"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200 shadow-md hover:shadow-lg">Logout</button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row bg-gray-50">
            <!-- Sidebar for Navigation and Search -->
            <aside class="w-full lg:w-1/4 bg-gray-50 border-r border-gray-200 p-4 sm:p-6 flex flex-col shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Data Modules</h2>

                <!-- Sidebar Search Bar (for modules) -->
                <div class="relative mb-6">
                    <input type="text" id="searchInput" placeholder="Search Modules..."
                        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 shadow-sm" />
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        <svg class="lucide-search" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.3-4.3" />
                        </svg>
                    </div>
                </div>

                <!-- Quick Navigation Dropdown -->
                <div id="quickNav" class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200 shadow-sm">
                    <label for="quickAccessDropdown" class="block text-blue-700 text-sm font-semibold mb-2">Quick
                        Access:</label>
                    <select id="quickAccessDropdown"
                        class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white text-gray-800">
                        <option value="">Select a Module</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>

                <!-- Data Module List -->
                <nav class="flex-1 overflow-y-auto">
                    <ul id="moduleList">
                        <!-- Data modules will be dynamically loaded here by JavaScript -->
                    </ul>
                    <p id="noModulesMessage" class="text-gray-500 italic hidden text-center mt-8">No modules found.</p>
                </nav>

                <!-- Admin controls for adding new modules -->
                <div id="adminControls" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Admin Actions</h3>
                    <button id="addModuleBtn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                        Add New Project
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main id="mainContentArea" class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto relative bg-gray-100">
                <!-- Admin Action Buttons for Current Module (Edit/Delete) -->
                <div id="currentModuleAdminActions" class="flex flex-wrap justify-end gap-3 mb-6 hidden">
                    <button id="editCurrentModuleBtn"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-5 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105">
                        Edit Current Module
                    </button>
                    <button id="deleteCurrentModuleBtn"
                        class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105">
                        Delete Current Module
                    </button>
                    <!-- New Admin Download Buttons -->
                    <button id="downloadRawHtmlBtn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105">
                        Download Raw HTML
                    </button>
                    <button id="downloadRawXmlBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105">
                        Save as XML (File System API)
                    </button>
                </div>

                <!-- Content Display or Form for Admin -->
                <div id="contentDisplay"
                    class="bg-white p-6  justify-center items-center">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-lg text-center p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-book-open text-blue-400 mb-6">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                        </svg>
                        <p class="text-xl font-medium text-gray-600">Welcome to your IETM Dashboard!</p>
                        <p class="mt-2 text-gray-500 max-w-prose">Select a data module from the sidebar on the left to
                            view its content or manage it.</p>
                        <p class="mt-4 text-sm text-gray-400 italic">"Knowledge at your fingertips."</p>
                    </div>
                </div>

                <!-- Admin Form for Add/Edit Module -->
                <div id="moduleFormContainer"
                    class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hidden mt-8">
                    <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Add New Module</h2>
                    <form id="moduleForm">
                        <input type="hidden" id="moduleId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="moduleTitle" class="block text-gray-700 text-sm font-semibold mb-2">Title
                                    (Project Name / Main Topic / Subtopic Page):</label>
                                <input type="text" id="moduleTitle"
                                    class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
                                    required>
                            </div>
                            <div>
                                <label for="serialNumber" class="block text-gray-700 text-sm font-semibold mb-2">Serial
                                    Number (e.g., 1.0, 2.1.3):</label>
                                <input type="text" id="serialNumber"
                                    class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200">
                            </div>
                        </div>

                        <div class="mb-6" id="functionTopicNameGroup">
                            <label for="functionTopicName" class="block text-gray-700 text-sm font-semibold mb-2">Extra
                                Function Topic Name (for Project/Main Topics only):</label>
                            <input type="text" id="functionTopicName"
                                class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200">
                        </div>
                        <div class="mb-8" id="parentTopicContainer">
                            <label for="parentTopicSelect" class="block text-gray-700 text-sm font-semibold mb-2">Parent
                                Module (Optional):</label>
                            <select id="parentTopicSelect"
                                class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white transition duration-200">
                                <option value="">(None - Top Level Project)</option>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>

                        <!-- Primary Image Upload Section -->
                        <div class="mb-8 border p-5 rounded-xl bg-blue-50 border-blue-200 shadow-inner">
                            <label for="imageUploadInput" class="block text-blue-800 text-base font-bold mb-3">Upload
                                Primary Image (Optional - replaces Image URL):</label>
                            <input type="file" id="imageUploadInput" accept="image/*"
                                class="w-full text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-200 file:text-blue-800 hover:file:bg-blue-300 transition duration-200">
                            <div id="imagePreviewContainer" class="mt-5 hidden text-center">
                                <img id="imagePreview" src="" alt="Image Preview"
                                    class="max-w-full h-auto rounded-lg shadow-md mb-3 border border-gray-200 mx-auto">
                                <button type="button" id="clearImageBtn"
                                    class="text-red-600 hover:text-red-800 text-sm font-medium transition duration-200 py-1 px-2 rounded-md hover:bg-red-50">Clear
                                    Image</button>
                                <button type="button" id="openHotspotEditorBtn"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm mt-3 transition duration-200 shadow-md transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="inline-block mr-1 lucide lucide-map-pin">
                                        <path
                                            d="M12 18.35a2.71 2.71 0 0 1-4.7-2 8.32 8.32 0 0 1-.22-2.75l.06-.55s1.7-1.37 2.07-3.96V3.71l.5-.72C9.5 2.15 10.5 2 12 2s2.5.15 2.94.99l.5.72v5.39c.37 2.59 2.07 3.96 2.07 3.96l.06.55a8.32 8.32 0 0 1-.22 2.75 2.71 2.71 0 0 1-4.7 2Z" />
                                        <path d="M12 22v-3.5" />
                                    </svg>
                                    Define Hotspots
                                </button>
                            </div>
                        </div>

                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-3">
                                <label for="moduleContent" class="block text-gray-700 text-base font-semibold">
                                    Content (HTML for Admin View):
                                    <span class="text-gray-500 font-normal text-xs ml-2">(Note: Local image uploads
                                        result in long Base64 `src` attributes. Use external URLs for shorter
                                        paths.)</span>
                                </label>
                                <button type="button" id="insertImageBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="inline-block mr-1 lucide lucide-image">
                                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                                        <circle cx="9" cy="9" r="2" />
                                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                                    </svg>
                                    Insert Image
                                </button>
                            </div>
                            <textarea id="moduleContent"
                                class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 h-64 transition duration-200 w-full h-full min-h-[calc(100vh-180px)] flex-grow"
                                required></textarea>
                        </div>

                        <!-- XML Content Section for User View (Auto-generated/Read-only for Admin) -->
                        <div class="mb-8">
                            <label for="xmlModuleContent"
                                class="block text-gray-700 text-base font-semibold mb-2">Content (XML for User View -
                                Auto-generated from HTML):</label>
                            <textarea id="xmlModuleContent"
                                class="shadow-sm appearance-none border border-gray-300 bg-gray-100 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 h-64 cursor-not-allowed w-full h-full min-h-[calc(100vh-180px)] flex-grow"
                                readonly></textarea>
                            <p class="text-sm text-gray-500 mt-2">This XML content is automatically generated from the
                                HTML above and will be displayed to regular users in a formatted view.</p>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                            <button type="button" id="cancelFormBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-3 rounded-md transition duration-200 shadow-md transform hover:scale-105">Cancel</button>
                            <button type="submit"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-md transition duration-200 shadow-md transform hover:scale-105">Save
                                Module</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- Login Container -->
    <div id="loginContainer"
        class="bg-white rounded-2xl shadow-2xl p-10 w-full max-w-md transition-all duration-300 transform scale-100 border border-blue-200">
        <h2 class="text-4xl font-extrabold text-blue-800 mb-8 text-center">IETM Login</h2>
        <form id="loginForm">
            <div class="mb-6">
                <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                <input type="text" id="username"
                    class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    required>
            </div>
            <div class="mb-8">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="password"
                    class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    required>
            </div>
            <p id="loginError" class="text-red-500 text-sm mb-4 text-center hidden">Invalid username or password.</p>
            <button type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 shadow-lg transform hover:scale-105">
                Login
            </button>
            <p class="text-gray-500 text-sm mt-8 text-center">
                User: `user` / `password`
                <br>
                Admin: `admin` / `password`
            </p>
        </form>
    </div>

    <!-- Image Insertion Modal -->
    <div id="imageInsertModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeImageInsertModal">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Insert Image into Content</h2>
            <div class="flex flex-col space-y-4">
                <button type="button" id="insertImageUrlBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    Insert from URL
                </button>
                <button type="button" id="uploadLocalImageBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    Upload Local Image(s)
                </button>
            </div>
            <input type="file" id="hiddenLocalImageInput" accept="image/*" multiple class="hidden">
        </div>
    </div>

    <!-- Hotspot Editor Modal -->
    <div id="hotspotEditorModal" class="modal-overlay hidden">
        <div class="modal-content !max-w-4xl !p-6">
            <button class="modal-close-btn" id="closeHotspotEditorModal">&times;</button>
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Define Hotspots for Image</h2>
            <p class="text-gray-600 mb-6 text-sm">Click and drag on the image to draw a new hotspot. Then, select a
                target module and optionally add a tooltip.</p>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Image and Canvas Area -->
                <div
                    class="relative flex-1 bg-gray-200 rounded-lg overflow-hidden shadow-inner border border-gray-300 min-h-[200px] flex items-center justify-center">
                    <img id="hotspotEditorImage" src="" alt="Hotspot Image" class="block max-w-full h-auto"
                        style="user-select: none; -webkit-user-select: none; pointer-events: none;">
                    <canvas id="hotspotCanvas" class="absolute top-0 left-0 w-full h-full cursor-crosshair"></canvas>
                    <div id="hotspotCanvasOverlays" class="absolute top-0 left-0 w-full h-full pointer-events: none;">
                    </div>
                </div>

                <!-- Hotspot List and Controls -->
                <div class="w-full lg:w-96 flex flex-col">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Hotspot Details</h3>
                    <div class="mb-4">
                        <label for="hotspotTargetSelect" class="block text-gray-700 text-sm font-medium mb-1">Link to
                            Module:</label>
                        <select id="hotspotTargetSelect"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white text-gray-800">
                            <option value="">Select a module...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="hotspotTooltipInput" class="block text-gray-700 text-sm font-medium mb-1">Tooltip
                            Text (Optional):</label>
                        <input type="text" id="hotspotTooltipInput" placeholder="e.g., Engine Assembly Page"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-700">
                    </div>
                    <button id="addHotspotBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 shadow-md transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="inline-block mr-1 lucide lucide-plus-square">
                            <rect width="18" height="18" x="3" y="3" rx="2" />
                            <path d="M8 12h8" />
                            <path d="M12 8v8" />
                        </svg>
                        Add Current Hotspot
                    </button>

                    <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">Defined Hotspots (<span
                            id="hotspotCount">0</span>)</h3>
                    <ul id="definedHotspotsList"
                        class="flex-1 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 mb-6">
                        <p class="text-gray-500 text-sm italic text-center py-4" id="noDefinedHotspotsMsg">No hotspots
                            defined yet.</p>
                    </ul>

                    <div class="flex justify-end gap-3 mt-auto pt-4 border-t border-gray-200">
                        <button id="cancelHotspotsBtn"
                            class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-md transition duration-200 shadow-md">Cancel</button>
                        <button id="saveHotspotsBtn"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Save
                            Hotspots</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Annotation Modal (Now for highlighting) -->
    <div id="annotationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAnnotationModal">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Add Annotation to Highlighted Text</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2">Highlighted Text Preview:</label>
                <p id="highlightedTextPreview"
                    class="bg-gray-100 p-3 rounded-md border border-gray-200 text-gray-700 italic max-h-24 overflow-y-auto">
                </p>
            </div>
            <form id="annotationForm">
                <div class="mb-6">
                    <label for="annotationText" class="block text-gray-700 text-sm font-semibold mb-2">Annotation
                        Text:</label>
                    <textarea id="annotationText"
                        class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 h-32"
                        required placeholder="Enter your annotation here..."></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelAnnotationBtn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-md transition duration-200 shadow-md">Cancel</button>
                    <button type="submit" id="saveAnnotationBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition duration-200 shadow-md">Save
                        Annotation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Full History Modal -->
    <div id="fullHistoryModal" class="modal-overlay hidden">
        <div class="modal-content !max-w-xl !p-6">
            <button class="modal-close-btn" id="closeFullHistoryModal">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Full Project History</h2>
            <div class="flex items-center space-x-2 mb-4">
                <input type="text" id="historySearchInput" placeholder="Filter history..."
                    class="flex-grow pl-3 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 shadow-sm">
                <select id="historyFilterSelect"
                    class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white text-gray-800">
                    <option value="all">All Types</option>
                    <option value="add">Added</option>
                    <option value="edit">Edited</option>
                    <option value="delete">Deleted</option>
                    <option value="annotate">Annotated</option>
                </select>
            </div>
            <ul id="historyList" class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 p-3">
                <p id="noHistoryMessage" class="text-gray-500 italic text-center py-4 hidden">No history entries found.
                </p>
                <!-- History items will be dynamically loaded here -->
            </ul>
        </div>
    </div>

    <script>
        // --- Hardcoded User Data (Simulated) ---
        const USERS = {
            'user': { password: 'password', role: 'user' },
            'admin': { password: 'password', role: 'admin' }
        };

        // --- DOM Elements ---
        const appContainer = document.getElementById('appContainer');
        const loginContainer = document.getElementById('loginContainer');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const userInfo = document.getElementById('userInfo');
        const logoutBtn = document.getElementById('logoutBtn');
        const appTitle = document.getElementById('appTitle'); // Get the h1 element for the title

        const searchInput = document.getElementById('searchInput'); // For module search
        const moduleList = document.getElementById('moduleList');
        const noModulesMessage = document.getElementById('noModulesMessage');
        const contentDisplay = document.getElementById('contentDisplay');
        const adminControls = document.getElementById('adminControls');
        const addModuleBtn = document.getElementById('addModuleBtn');
        const moduleFormContainer = document.getElementById('moduleFormContainer');
        const moduleForm = document.getElementById('moduleForm');
        const formTitle = document.getElementById('formTitle');
        const moduleIdInput = document.getElementById('moduleId');
        const moduleTitleInput = document.getElementById('moduleTitle');
        const serialNumberInput = document.getElementById('serialNumber'); // Serial Number Input
        const functionTopicNameInput = document.getElementById('functionTopicName');
        const functionTopicNameGroup = document.getElementById('functionTopicNameGroup');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const openHotspotEditorBtn = document.getElementById('openHotspotEditorBtn'); // New Hotspot button
        const moduleContentInput = document.getElementById('moduleContent');
        const xmlModuleContentInput = document.getElementById('xmlModuleContent'); // XML Content Input
        const insertImageBtn = document.getElementById('insertImageBtn');
        const parentTopicSelect = document.getElementById('parentTopicSelect');
        const cancelFormBtn = document.getElementById('cancelFormBtn');
        const quickNavDiv = document.getElementById('quickNav');
        const quickAccessDropdown = document.getElementById('quickAccessDropdown'); // Quick Access Dropdown

        const currentModuleAdminActions = document.getElementById('currentModuleAdminActions');
        const editCurrentModuleBtn = document.getElementById('editCurrentModuleBtn');
        const deleteCurrentModuleBtn = document.getElementById('deleteCurrentModuleBtn');
        const downloadRawHtmlBtn = document.getElementById('downloadRawHtmlBtn'); // New button
        const downloadRawXmlBtn = document.getElementById('downloadRawXmlBtn'); // New button

        // Page Navigation Elements
        const backBtn = document.getElementById('backBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const printBtn = document.getElementById('printBtn');
        const downloadBtn = document.getElementById('downloadBtn'); // Existing download for rendered HTML
        const fullHistoryBtn = document.getElementById('fullHistoryBtn'); // New Full History Button

        const chatBtn = document.getElementById('chatBtn');
        const helpBtn = document.getElementById('helpBtn');

        // Annotation Modal Elements (now for highlighting)
        const annotationModal = document.getElementById('annotationModal');
        const closeAnnotationModal = document.getElementById('closeAnnotationModal');
        const annotationForm = document.getElementById('annotationForm');
        const annotationTextarea = document.getElementById('annotationText');
        const highlightedTextPreview = document.getElementById('highlightedTextPreview');
        const cancelAnnotationBtn = document.getElementById('cancelAnnotationBtn');
        const saveAnnotationBtn = document.getElementById('saveAnnotationBtn');

        // Image Insert Modal Elements
        const imageInsertModal = document.getElementById('imageInsertModal');
        const closeImageInsertModal = document.getElementById('closeImageInsertModal');
        const insertImageUrlBtn = document.getElementById('insertImageUrlBtn');
        const uploadLocalImageBtn = document.getElementById('uploadLocalImageBtn');
        const hiddenLocalImageInput = document.getElementById('hiddenLocalImageInput');

        // Hotspot Editor Modal Elements
        const hotspotEditorModal = document.getElementById('hotspotEditorModal');
        const closeHotspotEditorModal = document.getElementById('closeHotspotEditorModal');
        const hotspotEditorImage = document.getElementById('hotspotEditorImage');
        const hotspotCanvas = document.getElementById('hotspotCanvas');
        const hotspotCanvasOverlays = document.getElementById('hotspotCanvasOverlays'); // For displaying actual clickable hotspots in editor
        const hotspotTargetSelect = document.getElementById('hotspotTargetSelect');
        const hotspotTooltipInput = document.getElementById('hotspotTooltipInput');
        const addHotspotBtn = document.getElementById('addHotspotBtn');
        const definedHotspotsList = document.getElementById('definedHotspotsList');
        const noDefinedHotspotsMsg = document.getElementById('noDefinedHotspotsMsg');
        const hotspotCount = document.getElementById('hotspotCount');
        const cancelHotspotsBtn = document.getElementById('cancelHotspotsBtn');
        const saveHotspotsBtn = document.getElementById('saveHotspotsBtn');

        // Full History Modal Elements
        const fullHistoryModal = document.getElementById('fullHistoryModal');
        const closeFullHistoryModal = document.getElementById('closeFullHistoryModal');
        const historyList = document.getElementById('historyList');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        const historySearchInput = document.getElementById('historySearchInput');
        const historyFilterSelect = document.getElementById('historyFilterSelect');


        // --- Global State ---
        let currentUser = null; // Stores { username, role }
        let selectedModuleId = null; // Currently selected data module
        let currentImageBase64 = null; // Stores the Base64 string of the uploaded primary image
        let currentHotspots = []; // Hotspots for the module currently being edited
        let drawingRect = null; // { startX, startY, currentX, currentY } for drawing
        let isDrawing = false;
        let selectedRange = null; // Stores the TextRange for selected text for annotation
        let uniqueAnnotationCounter = 0; // To generate unique IDs for annotations in HTML


        // History for back/forward navigation
        let moduleHistory = [];
        let historyIndex = -1;
        const MAX_HISTORY_LENGTH = 50; // Max number of modules to keep in history

        // Load data modules from localStorage or initialize as empty if no data exists
        // THIS IS WHERE YOUR APPLICATION'S INTERNAL DATA IS STORED "LOCATION WISE"
        // Each module object in this array contains `parentId` and `level` which define its
        // "location" within the hierarchical structure of your IETM.
        let dataModules = JSON.parse(localStorage.getItem('ietmModules')) || [];

        // Global history for all actions
        let appHistory = JSON.parse(localStorage.getItem('ietmAppHistory')) || [];

        // --- Utility Functions ---

        /**
         * Safely escapes HTML special characters for display as plain text.
         * Useful for showing raw HTML/XML content within <pre> tags.
         * @param {string} str The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        /**
         * Saves data modules to localStorage.
         * This function is crucial for persisting the "location wise" hierarchy of your data.
         * Every time a module is added, edited, or deleted, this updates the single
         * 'ietmModules' entry in localStorage, reflecting the current state of the hierarchy.
         */
        function saveModules() {
            localStorage.setItem('ietmModules', JSON.stringify(dataModules));
        }

        /**
         * Saves app history to localStorage.
         * This tracks all additions, edits, deletions, and annotations.
         */
        function saveAppHistory() {
            localStorage.setItem('ietmAppHistory', JSON.stringify(appHistory));
        }

        /**
         * Adds an entry to the global application history.
         * @param {string} action The type of action (e.g., 'add', 'edit', 'delete', 'annotate').
         * @param {string} moduleId The ID of the module affected.
         * @param {string} moduleTitle The title of the module affected.
         * @param {string} description A more detailed description of the action.
         */
        function addHistoryEntry(action, moduleId, moduleTitle, description) {
            const timestamp = new Date().toISOString();
            appHistory.unshift({ // Add to the beginning for reverse chronological order
                timestamp,
                user: currentUser ? currentUser.username : 'System',
                role: currentUser ? currentUser.role : 'System',
                action,
                moduleId,
                moduleTitle,
                description
            });
            // Keep history reasonably sized
            if (appHistory.length > 500) { // Limit to 500 entries
                appHistory = appHistory.slice(0, 500);
            }
            saveAppHistory();
        }


        /**
         * Generates a simple unique ID for new modules.
         * Attempts to make it slightly more readable by using a prefix from the title.
         */
        function generateUniqueId(title) {
            // Remove special characters and spaces, take first 10, uppercase
            const cleanTitle = title.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10).toUpperCase();
            // Append a timestamp slice for uniqueness
            return `${cleanTitle || 'MODULE'}-${Date.now().toString().slice(-6)}`;
        }

        /**
         * Toggles the expanded state of a module in the sidebar.
         * @param {string} id The ID of the module to toggle.
         */
        function toggleModuleExpanded(id) {
            dataModules = dataModules.map(module =>
                module.id === id ? { ...module, expanded: !module.expanded } : module
            );
            saveModules();
            renderModuleList(searchInput.value);
            populateQuickAccessDropdown(); // Update quick access dropdown
        }

        /**
         * Renders the list of data modules in the sidebar, filtered by search term.
         * Handles hierarchy, expanded state, and admin actions.
         * @param {string} searchTerm The current search term.
         */
        function renderModuleList(searchTerm = '') {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredModules = dataModules.filter(module =>
                module.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                module.id.toLowerCase().includes(lowerCaseSearchTerm) ||
                (module.serialNumber && module.serialNumber.toLowerCase().includes(lowerCaseSearchTerm)) || // Search by serial number
                (module.functionTopicName && module.functionTopicName.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (module.content && module.content.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (module.xmlContent && module.xmlContent.toLowerCase().includes(lowerCaseSearchTerm)) // Search XML content too
            );

            // Group modules by parentId for hierarchical rendering
            const modulesByParent = filteredModules.reduce((acc, module) => {
                const parentKey = module.parentId || 'root'; // 'root' for top-level projects
                if (!acc[parentKey]) {
                    acc[parentKey] = [];
                }
                acc[parentKey].push(module);
                return acc;
            }, {});

            // Recursive function to render children
            const renderChildren = (parentId, indentLevel) => {
                const children = (modulesByParent[parentId] || []).sort((a, b) => {
                    // Sort by serial number if present, otherwise by title
                    const serialA = parseFloat(a.serialNumber) || Infinity;
                    const serialB = parseFloat(b.serialNumber) || Infinity;
                    if (serialA !== Infinity && serialB !== Infinity && serialA !== serialB) {
                        return serialA - serialB;
                    }
                    return a.title.localeCompare(b.title);
                });
                children.forEach(childModule => {
                    appendModuleToList(childModule, indentLevel);
                    // Continue rendering if module is expanded OR if search term is active (to show all matched descendants)
                    if (childModule.expanded || searchTerm) {
                        renderChildren(childModule.id, indentLevel + 1);
                    }
                });
            };

            moduleList.innerHTML = ''; // Clear current list

            if (filteredModules.length === 0) {
                noModulesMessage.classList.remove('hidden');
            } else {
                noModulesMessage.classList.add('hidden');

                // Start rendering from root (Level 0 projects)
                const sortedRootModules = (modulesByParent.root || []).sort((a, b) => {
                    const serialA = parseFloat(a.serialNumber) || Infinity;
                    const serialB = parseFloat(b.serialNumber) || Infinity;
                    if (serialA !== Infinity && serialB !== Infinity && serialA !== serialB) {
                        return serialA - serialB;
                    }
                    return a.title.localeCompare(b.title);
                });
                sortedRootModules.forEach(mainModule => {
                    appendModuleToList(mainModule, 0);
                    if (mainModule.expanded || searchTerm) {
                        renderChildren(mainModule.id, 1); // Start children at indent level 1
                    }
                });
            }
        }

        /**
         * Appends a module to the moduleList DOM.
         * @param {object} module The module object.
         * @param {number} indentLevel The level of indentation (0 for project, 1 for main topic, 2 for subtopic page, 3 for sub-subtopic page).
         */
        function appendModuleToList(module, indentLevel) {
            const listItem = document.createElement('li');
            listItem.className = `list-item-container`; // Uses custom CSS for margin-bottom

            // Calculate base left position for lines
            const baseLeft = 10; // Base offset from the left edge of the sidebar list item
            const indentWidth = 30; // Pixels per indent level

            // Add vertical line for children
            if (module.parentId) {
                const verticalLine = document.createElement('div');
                verticalLine.className = 'vertical-line';
                verticalLine.style.left = `${baseLeft + ((indentLevel - 1) * indentWidth) + 12}px`; // Align with parent's line
                listItem.appendChild(verticalLine);
            }

            const button = document.createElement('button');
            button.className = `module-button group ${selectedModuleId === module.id ? 'active' : ''}`;
            button.onclick = () => handleModuleSelect(module.id);

            // Add horizontal line for any child item (level > 0)
            if (indentLevel > 0) {
                const horizontalLine = document.createElement('div');
                horizontalLine.className = 'horizontal-line';
                horizontalLine.style.left = `${baseLeft + ((indentLevel - 1) * indentWidth) + 12}px`; // Connects to vertical line
                horizontalLine.style.width = `${indentWidth - 12}px`; // Length of the horizontal connector
                button.appendChild(horizontalLine);
            }

            const textContainer = document.createElement('div');
            // Dynamically set padding using style attribute for precise pixel control
            textContainer.className = `text-container`; // No px classes here
            textContainer.style.paddingLeft = `${(indentLevel * indentWidth)}px`; // Adjust padding for consistent spacing

            // Toggle arrow for modules that can have children (any level that can be a parent)
            const hasChildren = dataModules.some(m => m.parentId === module.id);
            if (hasChildren) {
                const toggleArrow = document.createElement('span');
                toggleArrow.className = `module-toggle-arrow ${module.expanded ? 'expanded' : ''}`;
                toggleArrow.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                `;
                toggleArrow.onclick = (e) => {
                    e.stopPropagation(); // Prevent selecting module when clicking arrow
                    toggleModuleExpanded(module.id);
                };
                textContainer.appendChild(toggleArrow);
            } else {
                // Placeholder for alignment if no arrow
                const indentPlaceholder = document.createElement('span');
                indentPlaceholder.className = 'mr-2 inline-block';
                indentPlaceholder.style.width = '16px'; // Match arrow width for alignment
                textContainer.appendChild(indentPlaceholder);
            }

            // Folder Icon (always yellow and present)
            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon-color';
            folderIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9L.63 2.14a2 2 0 0 0-.63-.14H4a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h3.93a2 2 0 0 1 1.66.9l.78 1.16C10.74 4.54 11.39 4 12.06 4H20a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h3.93a2 2 0 0 1 1.66.9l.78 1.16C10.74 4.54 11.39 4 12.06 4H20a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4Z"/></svg>
            `;
            textContainer.appendChild(folderIcon);

            // Display serial number, if available, before the title
            if (module.serialNumber) {
                const serialPrefix = document.createElement('span');
                serialPrefix.className = 'serial-prefix'; // Class for default styling
                serialPrefix.textContent = `${module.serialNumber}.`;
                textContainer.appendChild(serialPrefix);
            }

            const moduleTitleSpan = document.createElement('span');
            moduleTitleSpan.className = 'module-title'; // Class for default styling
            moduleTitleSpan.textContent = module.title;
            textContainer.appendChild(moduleTitleSpan);

            // Optionally display functionTopicName next to the title in the list for main topics or projects
            if (module.level < 2 && module.functionTopicName) { // Apply to projects (level 0) and main topics (level 1)
                const functionTopicSpan = document.createElement('span');
                functionTopicSpan.className = 'function-topic-name'; // Class for default styling
                functionTopicSpan.textContent = `(${module.functionTopicName})`;
                textContainer.appendChild(functionTopicSpan);
            }

            button.appendChild(textContainer);

            // Admin specific actions (add page, edit, delete buttons)
            if (currentUser && currentUser.role === 'admin') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'admin-actions'; // Use new class for styling

                // Add "Add Page" button for modules that can have children (level 0, 1, and now 2)
                const MAX_ADD_PAGE_LEVEL = 2; // Allow adding child to Level 0, 1, and 2 modules (creating Level 1, 2, 3)
                if (module.level <= MAX_ADD_PAGE_LEVEL) {
                    const addPageBtn = document.createElement('button');
                    addPageBtn.className = 'add-page-btn group-[.active]:text-blue-200 hover:text-purple-400 p-1 rounded-md'
                    let addPageTitle = '';
                    if (module.level === 0) {
                        addPageTitle = 'Add new main topic';
                    }
                    else if (module.level === 1) {
                        addPageTitle = 'Add new subtopic page';
                    }
                    else if (module.level === 2) {
                        addPageTitle = 'Add new sub-subtopic page';
                    }
                    addPageBtn.title = addPageTitle;
                    addPageBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`;
                    addPageBtn.onclick = (e) => {
                        e.stopPropagation(); // Prevent selecting the module when clicking button
                        addRelatedModule(module.id); // Reusing addRelatedModule for consistency
                    };
                    actionsDiv.appendChild(addPageBtn);
                }


                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn group-[.active]:text-yellow-200 hover:text-yellow-400 p-1 rounded-md';
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`;
                editBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent selecting the module when clicking edit
                    editModule(module.id);
                };
                actionsDiv.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn group-[.active]:text-red-200 hover:text-red-400 p-1 rounded-md';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent selecting the module when clicking delete
                    // Using a custom modal-like message box instead of alert/confirm for better UX.
                    // This is handled by `displayConfirmMessageBox` function later in the script.
                    displayConfirmMessageBox(`Are you sure you want to delete this module ("${module.title}") and its sub-topics?`, () => {
                        deleteModule(module.id);
                        displayTemporaryMessage("Module(s) deleted successfully!", 'success');
                    }, () => {
                        displayTemporaryMessage("Deletion cancelled.", 'info');
                    });
                };
                actionsDiv.appendChild(deleteBtn);
                button.appendChild(actionsDiv);
            }
            listItem.appendChild(button);
            moduleList.appendChild(listItem);
        }

        /**
         * Handles the selection of a data module to display its content.
         * @param {string} id The ID of the module to select.
         * @param {boolean} fromHistory Optional. True if this selection comes from history navigation.
         */
        function handleModuleSelect(id, fromHistory = false) {
            selectedModuleId = id;
            renderModuleList(searchInput.value); // Re-render to update active state
            renderContent(id);
            moduleFormContainer.classList.add('hidden'); // Hide form if visible
            contentDisplay.classList.remove('hidden'); // Show content display

            // Update quick access dropdown to reflect selection
            quickAccessDropdown.value = id;

            // Add to history if not navigating from history buttons
            if (!fromHistory) {
                addToHistory(id);
            }
            updateNavigationButtons(); // Update back/forward button states
        }

        /**
         * Renders the content of the selected data module in the main area.
         * Content rendering depends on the current user's role.
         * Admins see raw HTML, users see formatted XML.
         * @param {string} id The ID of the module whose content to render.
         */
        function renderContent(id) {
            const module = dataModules.find(dm => dm.id === id);
            if (module) {
                let contentHtml = `<div class="bg-white p-6 rounded-xl shadow-inner border border-gray-100">`;

                const serialDisplay = module.serialNumber ? `<span class="text-xl font-semibold text-gray-700 mr-2">${module.serialNumber}.</span>` : '';

                // Display the module ID prominently next to the title.
                // Removed bg-blue-100, text-blue-800, shadow-md classes for plain text.
                contentHtml += `
                    <div class="flex flex-wrap items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-blue-700 leading-tight flex items-center mb-2 sm:mb-0">
                            ${serialDisplay}<span>${module.title}</span>
                        </h2>
                        <span class="text-gray-500 text-sm font-semibold px-3 py-1 rounded-full select-all text-right max-w-full overflow-hidden text-ellipsis whitespace-nowrap">
                            ${module.id}
                        </span>
                    </div>
                `;

                // Display the 'Extra Function Topic' if it exists for Level 0 or Level 1 modules.
                if (module.level < 2 && module.functionTopicName) {
                    contentHtml += `<p class="text-lg text-gray-700 mb-4"><span class="font-semibold">Extra Function Topic:</span> ${module.functionTopicName}</p>`;
                }

                // Add horizontal rule for visual separation before main content if there was a function topic.
                if (module.level < 2 && module.functionTopicName) {
                    contentHtml += `<hr class="my-4 border-gray-200">`;
                }

                // Primary image (always shown if present, regardless of content type)
                if (module.imageUrl) {
                    // Wrap primary image in a downloadable container and a relative div for hotspots
                    contentHtml += `
                        <div class="image-container relative">
                            <img id="primaryModuleImage" src="${module.imageUrl}" alt="${module.title} Image" class="block max-w-full h-auto rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/600x300/CCCCCC/666666?text=Main+Image+Failed+to+Load';">
                            <button class="image-download-btn" title="Download Image" data-image-src="${module.imageUrl}" data-image-alt="${module.title.replace(/[^a-zA-Z0-9]/g, '_')}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            </button>
                        </div>
                    `;
                }

                // Display content based on user role
                if (currentUser && currentUser.role === 'admin') {
                    // Admin sees HTML content
                    contentHtml += `<h3 class="text-lg font-semibold mt-4 mb-2">HTML Content (Admin View):</h3>`;
                    // The #readableContent div now takes full width and height within its parent.
                    contentHtml += `<div id="readableContent" class="p-4 border border-gray-200 rounded-md w-full h-full min-h-[calc(100vh-250px)] overflow-auto">${module.content || '<p class="text-gray-500 italic">No HTML content for this module.</p>'}</div>`;
                } else { // User sees formatted XML content and active hotspots
                    contentHtml += `<h3 class="text-lg font-semibold mt-4 mb-2">Formatted Content (User View):</h3>`;
                    if (module.xmlContent) {
                        try {
                            // Render XML to HTML here for users
                            contentHtml += `<div id="readableContent" class="rendered-xml">${renderXmlAsHtml(module.xmlContent)}</div>`;
                        } catch (e) {
                            contentHtml += `<p class="text-red-500 italic">Error rendering XML content: ${e.message}</p>`;
                            contentHtml += `<pre class="bg-gray-100 p-4 rounded-md overflow-auto text-sm text-gray-800 border border-gray-200 whitespace-pre-wrap"><strong>Raw XML (Error in rendering):</strong>\n${escapeHtml(module.xmlContent)}</pre>`;
                        }
                    } else {
                        contentHtml += `<p class="text-red-500 italic">No XML content defined for user view.</p>`;
                    }
                }
                contentHtml += `</div>`; // Close content-display-bg-white div

                contentDisplay.innerHTML = contentHtml;

                // Add event listener for hotspot clicks - only applies to the rendered content
                const readableContentDiv = contentDisplay.querySelector('#readableContent');
                if (readableContentDiv) {
                    readableContentDiv.addEventListener('click', handleHotspotClick);
                    // Add event listener for text selection for annotation (Admin only)
                    if (currentUser && currentUser.role === 'admin') {
                        readableContentDiv.addEventListener('mouseup', handleTextSelection);
                    }
                }

                // Attach event listeners to newly rendered image download buttons
                // These buttons will trigger the browser's "Save As" dialog allowing the user to select a local folder.
                contentDisplay.querySelectorAll('.image-download-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent image click from doing something else if it becomes a link
                        const imgSrc = e.currentTarget.dataset.imageSrc;
                        const imgAlt = e.currentTarget.dataset.imageAlt || 'image';
                        downloadImage(imgSrc, imgAlt);
                    });
                });

                // Attach event listeners to annotation tooltips for deletion (Admin only)
                if (currentUser && currentUser.role === 'admin') {
                    contentDisplay.querySelectorAll('.annotation-tooltip-delete').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent clicking the highlighted text itself
                            const annotationIdToDelete = e.currentTarget.dataset.annotationId;
                            displayConfirmMessageBox('Are you sure you want to delete this annotation?', () => {
                                deleteAnnotation(annotationIdToDelete);
                            });
                        });
                    });
                }


                // Render hotspots if in user view and hotspots exist for this module
                if (currentUser && currentUser.role === 'user' && module.hotspots && module.hotspots.length > 0) {
                    const primaryModuleImage = contentDisplay.querySelector('#primaryModuleImage');
                    if (primaryModuleImage) {
                        // Ensure image is loaded before attempting to draw/position hotspots
                        primaryModuleImage.onload = () => {
                            renderHotspotsOnUserView(module.hotspots, primaryModuleImage);
                        };
                        // If image is already loaded (e.g., from cache), trigger directly
                        if (primaryModuleImage.complete && primaryModuleImage.naturalHeight !== 0) {
                            renderHotspotsOnUserView(module.hotspots, primaryModuleImage);
                        }
                    }
                }

            } else {
                contentDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-lg text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open text-gray-400 mb-4"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <p>Select a data module from the left to view its content.</p>
                    </div>
                `;
            }
            // Show/hide current module admin actions (unchanged logic)
            if (currentUser && currentUser.role === 'admin' && selectedModuleId) {
                currentModuleAdminActions.classList.remove('hidden');
                // The annotate button is no longer a separate button, it's tied to text selection.
            } else {
                currentModuleAdminActions.classList.add('hidden');
            }
        }

        /**
         * Renders hotspots as clickable overlays on the primary image in the user view.
         * @param {Array<Object>} hotspots The array of hotspot objects.
         * @param {HTMLImageElement} imageElement The primary image element.
         */
        function renderHotspotsOnUserView(hotspots, imageElement) {
            const imageContainer = imageElement.parentElement;
            if (!imageContainer || !imageContainer.classList.contains('image-container')) {
                console.error("Hotspot rendering: Parent container not found or invalid.");
                return;
            }

            // Clear any previously rendered hotspots
            imageContainer.querySelectorAll('.rendered-hotspot').forEach(el => el.remove());

            const imgWidth = imageElement.offsetWidth;
            const imgHeight = imageElement.offsetHeight;

            hotspots.forEach(hotspot => {
                const hotspotDiv = document.createElement('div');
                hotspotDiv.className = 'rendered-hotspot';
                hotspotDiv.style.left = `${hotspot.x}%`;
                hotspotDiv.style.top = `${hotspot.y}%`;
                hotspotDiv.style.width = `${hotspot.width}%`;
                hotspotDiv.style.height = `${hotspot.height}%`;

                hotspotDiv.title = hotspot.tooltip || `Link to ${dataModules.find(m => m.id === hotspot.targetModuleId)?.title || hotspot.targetModuleId}`;
                hotspotDiv.dataset.targetModuleId = hotspot.targetModuleId; // Store target ID

                hotspotDiv.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent clicking the image behind
                    const targetId = e.currentTarget.dataset.targetModuleId;
                    handleModuleSelect(targetId);
                    displayTemporaryMessage(`Navigating to: ${e.currentTarget.title.replace('Link to ', '')}`, 'info');
                });
                imageContainer.appendChild(hotspotDiv);
            });
        }


        /**
         * Converts a data URL (Base64) to a Blob object.
         * From: https://stackoverflow.com/questions/16245767/creating-a-blob-from-a-base64-string-in-javascript
         * @param {string} dataurl The data URL (e.g., "data:image/png;base64,...")
         * @returns {Blob} The Blob object.
         */
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }


        /**
         * Downloads an image from a given URL or Base64 string.
         * This function saves the image to the user's local file system.
         * The exact "location" (folder) is chosen by the user via their browser's download prompt.
         * @param {string} imageUrl The URL or Base64 data URI of the image.
         * @param {string} suggestedFileName A suggested filename (without extension).
         */
        async function downloadImage(imageUrl, suggestedFileName = 'image') {
            try {
                let blob;
                let mimeType;

                if (imageUrl.startsWith('data:')) {
                    // It's a Base64 data URI
                    blob = dataURLtoBlob(imageUrl);
                    mimeType = blob.type;
                } else {
                    // It's a regular URL, fetch it
                    const response = await fetch(imageUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    blob = await response.blob();
                    mimeType = blob.type;
                }

                // Determine file extension from MIME type
                const extension = mimeType.split('/')[1] || 'png'; // Default to png if unknown
                const filename = `${suggestedFileName}.${extension}`;

                // Create a temporary anchor element and trigger download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename; // This sets the suggested filename
                document.body.appendChild(a); // Append to body for Firefox compatibility
                a.click(); // Programmatically click the anchor to trigger download
                document.body.removeChild(a); // Clean up the temporary element
                URL.revokeObjectURL(url); // Release the object URL

                displayTemporaryMessage(`Downloaded "${filename}". Your browser prompted you for a save location.`, 'success');
            } catch (error) {
                console.error('Error downloading image:', error);
                displayTemporaryMessage(`Failed to download image: ${error.message}.`, 'error');
            }
        }


        /**
         * Handles clicks on elements within the content area, specifically for hotspots.
         * @param {Event} event The click event.
         */
        function handleHotspotClick(event) {
            const target = event.target;
            const hotspotElement = target.closest('[data-hotspot]');
            if (hotspotElement) {
                const hotspotId = hotspotElement.dataset.hotspot;
                const targetModule = dataModules.find(dm => dm.id === hotspotId);
                if (targetModule) {
                    // Simulate navigation by selecting the module
                    handleModuleSelect(hotspotId);
                } else {
                    // Using a custom modal-like message box instead of alert/confirm
                    displayTemporaryMessage(`Hotspot link to ID "${hotspotId}" not found.`, 'error');
                }
            }
        }

        /**
         * Populates the parent topic select dropdown with current projects and main topics.
         */
        function populateParentTopicSelect() {
            parentTopicSelect.innerHTML = '<option value="">(None - Top Level Project)</option>';
            // Allow level 0 (projects), level 1 (main topics), and level 2 (subtopic pages) as parents
            const potentialParents = dataModules.filter(m => m.level < 3).sort((a, b) => {
                // Sort by serial number if present, otherwise by title
                const serialA = parseFloat(a.serialNumber) || Infinity;
                const serialB = parseFloat(b.serialNumber) || Infinity;
                if (serialA !== Infinity && serialB !== Infinity && serialA !== serialB) {
                    return serialA - serialB;
                }
                return a.title.localeCompare(b.title);
            });
            potentialParents.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                // Add appropriate indentation to parent options for clarity
                let prefix = '';
                if (topic.level === 0) {
                    prefix = 'Project: ';
                } else if (topic.level === 1) {
                    prefix = '   Main Topic: ';
                } else if (topic.level === 2) {
                    prefix = '     Subtopic Page: ';
                }
                const serialPrefix = topic.serialNumber ? `${topic.serialNumber}. ` : '';
                option.textContent = `${prefix}${serialPrefix}${topic.title}` + (topic.functionTopicName && topic.level < 2 ? ` (${topic.functionTopicName})` : '');
                parentTopicSelect.appendChild(option);
            });
        }

        /**
         * Populates the quick access dropdown with top-level projects and main topics.
         */
        function populateQuickAccessDropdown() {
            quickAccessDropdown.innerHTML = '<option value="">Select a Module</option>'; // Default option
            const quickAccessModules = dataModules.filter(m => m.level < 2).sort((a, b) => {
                // Sort by serial number if present, otherwise by title
                const serialA = parseFloat(a.serialNumber) || Infinity;
                const serialB = parseFloat(b.serialNumber) || Infinity;
                if (serialA !== Infinity && serialB !== Infinity && serialA !== serialB) {
                    return serialA - serialB;
                }
                return a.title.localeCompare(b.title);
            });
            quickAccessModules.forEach(module => {
                const option = document.createElement('option');
                option.value = module.id;
                const serialPrefix = module.serialNumber ? `${module.serialNumber}. ` : '';
                option.textContent = `${serialPrefix}${module.title}` + (module.functionTopicName ? ` (${module.functionTopicName})` : '');
                quickAccessDropdown.appendChild(option);
            });

            // Set the dropdown's value to the currently selected module, if any
            if (selectedModuleId) {
                quickAccessDropdown.value = selectedModuleId;
            } else {
                quickAccessDropdown.value = ""; // Reset if no module is selected
            }
        }

        /**
         * Populates the hotspot target select dropdown with all existing modules.
         */
        function populateHotspotTargetSelect() {
            hotspotTargetSelect.innerHTML = '<option value="">Select a module...</option>';
            // Include all modules except the one currently being edited for self-referencing prevention
            const currentModule = dataModules.find(m => m.id === moduleIdInput.value);
            const selectableModules = dataModules.filter(m => m.id !== (currentModule ? currentModule.id : null)).sort((a, b) => {
                // Sort by serial number then title for logical order
                const serialA = parseFloat(a.serialNumber) || Infinity;
                const serialB = parseFloat(b.serialNumber) || Infinity;
                if (serialA !== Infinity && serialB !== Infinity && serialA !== serialB) {
                    return serialA - serialB;
                }
                return a.title.localeCompare(b.title);
            });

            selectableModules.forEach(module => {
                const option = document.createElement('option');
                option.value = module.id;
                const serialPrefix = module.serialNumber ? `${module.serialNumber}. ` : '';
                option.textContent = `${serialPrefix}${module.title}` + (module.functionTopicName && module.level < 2 ? ` (${module.functionTopicName})` : '');
                hotspotTargetSelect.appendChild(option);
            });
        }


        /**
         * Updates the visibility of the "Extra Function Topic Name" input.
         */
        function updateFunctionTopicNameVisibility() {
            const selectedParentId = parentTopicSelect.value;
            let parentLevel = -1; // -1 for no parent (top level)
            if (selectedParentId) {
                const parentModule = dataModules.find(m => m.id === selectedParentId);
                if (parentModule) {
                    parentLevel = parentModule.level;
                }
            }
            const newModuleWillBeLevel = selectedParentId ? parentLevel + 1 : 0;

            if (newModuleWillBeLevel < 2) { // If new module will be Level 0 or Level 1
                functionTopicNameGroup.classList.remove('hidden');
                functionTopicNameInput.required = false; // Not strictly required, can be empty
            } else { // If new module will be Level 2 (Subtopic Page) or higher
                functionTopicNameGroup.classList.add('hidden');
                functionTopicNameInput.value = ''; // Clear value if hidden
                functionTopicNameInput.required = false;
            }
        }

        /**
         * Displays the form for adding a new module.
         */
        function showAddModuleForm() {
            formTitle.textContent = 'Add New Module';
            moduleIdInput.value = '';
            moduleTitleInput.value = '';
            serialNumberInput.value = ''; // Clear serial number field
            functionTopicNameInput.value = ''; // Clear new field
            moduleContentInput.value = '';
            xmlModuleContentInput.value = ''; // Clear XML content
            imageUploadInput.value = ''; // Clear file input
            imagePreview.src = ''; // Clear image preview
            imagePreviewContainer.classList.add('hidden'); // Hide preview container
            openHotspotEditorBtn.disabled = true; // Disable until image is uploaded
            currentImageBase64 = null; // Clear stored Base64
            currentHotspots = []; // Clear hotspots for new module

            // Reset parent selection and then populate for new entry
            parentTopicSelect.value = '';
            populateParentTopicSelect();
            // Update visibility based on no parent (Level 0)
            updateFunctionTopicNameVisibility();

            contentDisplay.classList.add('hidden');
            moduleFormContainer.classList.remove('hidden');
            currentModuleAdminActions.classList.add('hidden'); // Hide buttons when form is active


            // Trigger conversion when HTML content changes
            moduleContentInput.removeEventListener('input', updateXmlContent); // Remove old listener if exists
            moduleContentInput.addEventListener('input', updateXmlContent);
        }

        /**
         * Function to pre-fill the form for adding a module related to a specific parent.
         * This can be used for adding a main topic to a project, or a subtopic page to a main topic, or a sub-subtopic page.
         * @param {string} parentId The ID of the parent module.
         */
        function addRelatedModule(parentId) {
            showAddModuleForm(); // Show the add module form (which clears everything)
            parentTopicSelect.value = parentId; // Set the parent topic automatically
            // Manually trigger change to update function topic name visibility
            updateFunctionTopicNameVisibility();

            const parentModule = dataModules.find(m => m.id === parentId);
            if (parentModule) {
                let newTitle = '';
                if (parentModule.level === 0) {
                    newTitle = `Add Main Topic to Project: "${parentModule.title}"`;
                    displayTemporaryMessage(`Adding new main topic to project: "${parentModule.title}"`, 'info');
                } else if (parentModule.level === 1) {
                    newTitle = `Add Subtopic Page to Main Topic: "${parentModule.title}"`;
                    displayTemporaryMessage(`Adding new subtopic page to main topic: "${parentModule.title}"`, 'info');
                } else if (parentModule.level === 2) { // New case for Level 2 parents
                    newTitle = `Add Sub-Subtopic Page to Subtopic Page: "${parentModule.title}"`;
                    displayTemporaryMessage(`Adding new sub-subtopic page to subtopic page: "${parentModule.title}"`, 'info');
                }
                formTitle.textContent = newTitle;
            }
        }


        /**
         * Displays the form for editing an existing module.
         * @param {string} id The ID of the module to edit.
         */
        function editModule(id) {
            const moduleToEdit = dataModules.find(m => m.id === id);
            if (moduleToEdit) {
                formTitle.textContent = 'Edit Module';
                moduleIdInput.value = moduleToEdit.id;
                moduleTitleInput.value = moduleToEdit.title;
                serialNumberInput.value = moduleToEdit.serialNumber || ''; // Set serial number
                functionTopicNameInput.value = moduleToEdit.functionTopicName || ''; // Set new field
                moduleContentInput.value = moduleToEdit.content;
                xmlModuleContentInput.value = moduleToEdit.xmlContent || ''; // Populate XML content
                currentHotspots = JSON.parse(JSON.stringify(moduleToEdit.hotspots || [])); // Deep copy for editing

                // Handle existing primary image for editing
                if (moduleToEdit.imageUrl) {
                    imagePreview.src = moduleToEdit.imageUrl;
                    imagePreviewContainer.classList.remove('hidden');
                    openHotspotEditorBtn.disabled = false; // Enable hotspot button if image exists
                    currentImageBase64 = moduleToEdit.imageUrl; // Set for saving
                } else {
                    imagePreview.src = '';
                    imagePreviewContainer.classList.add('hidden');
                    openHotspotEditorBtn.disabled = true; // Disable if no image
                    currentImageBase64 = null;
                }
                imageUploadInput.value = ''; // Clear file input so user can pick a new one

                populateParentTopicSelect(); // Populate all options first

                // Select the correct parent if it's a sub-topic
                if (moduleToEdit.parentId) {
                    parentTopicSelect.value = moduleToEdit.parentId;
                } else {
                    parentTopicSelect.value = ''; // No parent
                }
                updateFunctionTopicNameVisibility(); // Update visibility based on current parent

                // Disable parent selection if editing a module that has children, or a module at the deepest allowed level
                const hasChildren = dataModules.some(m => m.parentId === moduleToEdit.id);
                // Parent cannot be changed if it has children, or if it's already a Level 3 module.
                const MAX_ADD_PAGE_LEVEL = 2; // Defined this locally for editModule context
                parentTopicSelect.disabled = hasChildren || (moduleToEdit.level > MAX_ADD_PAGE_LEVEL);


                contentDisplay.classList.add('hidden');
                moduleFormContainer.classList.remove('hidden');
                currentModuleAdminActions.classList.add('hidden'); // Hide buttons when form is active


                // Trigger conversion when HTML content changes
                moduleContentInput.removeEventListener('input', updateXmlContent); // Ensure only one listener
                moduleContentInput.addEventListener('input', updateXmlContent);
            }
        }

        /**
         * Saves (adds or updates) a module from the form.
         * This function updates the `dataModules` array, which contains the "location wise"
         * information (`parentId`, `level`, `serialNumber`) for each module,
         * and then calls `saveModules()` to persist it to `localStorage`.
         * @param {Event} event The form submission event.
         */
        function saveModule(event) {
            event.preventDefault();
            const id = moduleIdInput.value;
            const title = moduleTitleInput.value;
            const content = moduleContentInput.value; // Get HTML content from textarea
            // XML content is auto-generated in updateXmlContent, so we take it from the read-only textarea
            const xmlContent = xmlModuleContentInput.value;
            const parentId = parentTopicSelect.value || null; // Get selected parent ID
            const serialNumber = serialNumberInput.value.trim(); // Get serial number

            // Determine the level of the new/updated module
            // This 'level' property is crucial for maintaining the hierarchy ("location wise" data)
            let currentModuleLevel = 0; // Default for new top-level
            if (parentId) {
                const parentModule = dataModules.find(m => m.id === parentId);
                if (parentModule) {
                    currentModuleLevel = parentModule.level + 1;
                }
            } else if (id) { // If editing existing and no parent, it remains top-level
                const existingModule = dataModules.find(m => m.id === id);
                if (existingModule) {
                    currentModuleLevel = existingModule.level;
                }
            }


            // Only save functionTopicName if the module itself is Level 0 (Project) or Level 1 (Main Topic)
            const functionTopicName = (currentModuleLevel < 2) ? functionTopicNameInput.value.trim() : null;

            let updatedModule = null;
            let actionType = '';
            let actionDescription = '';

            if (id) {
                // Update existing
                const oldModule = dataModules.find(m => m.id === id);
                actionType = 'edit';
                actionDescription = `Edited module "${title}" (ID: ${id})`;

                dataModules = dataModules.map(m => {
                    if (m.id === id) {
                        updatedModule = {
                            ...m,
                            title,
                            serialNumber: serialNumber, // Save serial number (part of "location wise" ordering)
                            functionTopicName: functionTopicName,
                            imageUrl: currentImageBase64, // Save current Base64 image
                            content, // Save HTML content from textarea
                            xmlContent, // Save XML content from textarea
                            parentId: parentId, // Save parentId (crucial for "location wise" hierarchy)
                            level: currentModuleLevel, // Save level (crucial for "location wise" hierarchy)
                            hotspots: currentHotspots, // Save hotspots
                            annotations: m.annotations || [] // Preserve existing annotations
                        };
                        return updatedModule;
                    }
                    return m;
                });
            } else {
                // Add new
                const newId = generateUniqueId(title);
                actionType = 'add';
                actionDescription = `Added new module "${title}" (ID: ${newId})`;

                updatedModule = {
                    id: newId,
                    title,
                    serialNumber: serialNumber, // Save serial number
                    functionTopicName: functionTopicName,
                    imageUrl: currentImageBase64, // Save current Base64 image
                    content, // Save HTML content from textarea
                    xmlContent, // Save XML content from textarea
                    parentId: parentId, // Save parentId
                    level: currentModuleLevel, // Save level
                    expanded: true,
                    hotspots: currentHotspots, // Save hotspots
                    annotations: [] // Initialize empty annotations array for new modules
                };
                dataModules.push(updatedModule);
            }
            saveModules(); // Persist the updated dataModules array to localStorage
            addHistoryEntry(actionType, updatedModule.id, updatedModule.title, actionDescription); // Add to history

            renderModuleList(searchInput.value);
            populateQuickAccessDropdown(); // Update quick access dropdown after save
            // Select the newly added/updated module. Use its actual ID.
            handleModuleSelect(updatedModule.id);
            moduleFormContainer.classList.add('hidden'); // Hide form
            contentDisplay.classList.remove('hidden'); // Show content display
        }

        /**
         * Deletes a data module and its sub-topics recursively.
         * This function modifies the `dataModules` array to remove the module(s)
         * and then calls `saveModules()` to update the `localStorage` entry,
         * effectively removing them from the "location wise" structure.
         * @param {string} id The ID of the module to delete.
         */
        function deleteModule(id) {
            const modulesToDelete = [id]; // Start with the module itself
            const moduleToDeleteData = dataModules.find(m => m.id === id); // Get data for history

            // Find all direct children to delete recursively
            const findChildrenToDelete = (parentId) => {
                const children = dataModules.filter(m => m.parentId === parentId);
                children.forEach(child => {
                    modulesToDelete.push(child.id);
                    findChildrenToDelete(child.id); // In case of deeper nesting
                });
            };

            findChildrenToDelete(id); // Find children of the initial module

            dataModules = dataModules.filter(m => !modulesToDelete.includes(m.id));
            saveModules(); // Persist the updated dataModules array to localStorage
            // Add to history
            addHistoryEntry('delete', id, moduleToDeleteData ? moduleToDeleteData.title : 'Unknown Module', `Deleted module "${moduleToDeleteData ? moduleToDeleteData.title : 'Unknown Module'}" and its ${modulesToDelete.length - 1} sub-modules.`);


            renderModuleList(searchInput.value);
            populateQuickAccessDropdown(); // Update quick access dropdown after delete

            // If the deleted module was currently selected, clear content display
            if (selectedModuleId && modulesToDelete.includes(selectedModuleId)) {
                selectedModuleId = null;
                contentDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-lg text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open text-gray-400 mb-4"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <p>Module(s) deleted. Select another data module from the left.</p>
                    </div>
                `;
            }
            currentModuleAdminActions.classList.add('hidden'); // Hide buttons after deletion

        }

        /**
         * Adds a module ID to the history stack.
         * @param {string} moduleId The ID of the module to add.
         */
        function addToHistory(moduleId) {
            // If we navigated back and then selected a new module, clear the "forward" history
            if (historyIndex < moduleHistory.length - 1) {
                moduleHistory = moduleHistory.slice(0, historyIndex + 1);
            }
            moduleHistory.push(moduleId);
            // Limit history length
            if (moduleHistory.length > MAX_HISTORY_LENGTH) {
                moduleHistory.shift(); // Remove the oldest item
            }
            historyIndex = moduleHistory.length - 1;
            updateNavigationButtons();
        }

        /**
         * Navigates back in module history.
         */
        function goBack() {
            if (historyIndex > 0) {
                historyIndex--;
                handleModuleSelect(moduleHistory[historyIndex], true); // true to indicate from history
            }
        }

        /**
         * Navigates forward in module history.
         */
        function goForward() {
            if (historyIndex < moduleHistory.length - 1) {
                historyIndex++;
                handleModuleSelect(moduleHistory[historyIndex], true); // true to indicate from history
            }
        }

        /**
         * Updates the enabled/disabled state of back and forward navigation buttons.
         */
        function updateNavigationButtons() {
            backBtn.disabled = historyIndex <= 0;
            forwardBtn.disabled = historyIndex >= moduleHistory.length - 1;
            // Print and Download buttons are enabled if content is displayed
            const isContentDisplayed = selectedModuleId !== null;
            printBtn.disabled = !isContentDisplayed;
            downloadBtn.disabled = !isContentDisplayed;
            downloadRawHtmlBtn.disabled = !isContentDisplayed;
            downloadRawXmlBtn.disabled = !isContentDisplayed;
        }

        /**
         * Refreshes the content of the currently selected module.
         */
        function refreshCurrentModule() {
            if (selectedModuleId) {
                renderContent(selectedModuleId);
                displayTemporaryMessage('Content refreshed.', 'info');
            } else {
                displayTemporaryMessage('No module selected to refresh.', 'info');
            }
        }

        /**
         * Initiates printing of the content display area using a new window for clean print.
         */
        function printCurrentContent() {
            if (!selectedModuleId) {
                displayTemporaryMessage('No content selected to print.', 'info');
                return;
            }

            const module = dataModules.find(dm => dm.id === selectedModuleId);
            if (!module) {
                displayTemporaryMessage('Selected module not found for print.', 'error');
                return;
            }

            let contentToPrintHtml = '';
            // For printing, we always want the user-facing formatted content
            try {
                contentToPrintHtml = renderXmlAsHtml(module.xmlContent);
            } catch (e) {
                displayTemporaryMessage(`Error preparing XML for print: ${e.message}`, 'error');
                return;
            }


            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${module.title} - Print View</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        /* Print-specific CSS */
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Inter', sans-serif;
                            background-color: #ffffff;
                            color: #000000;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            font-size: 11pt; /* Base font size for print */
                        }
                        .print-container {
                            width: 100%;
                            max-width: 210mm; /* A4 width */
                            margin: 0 auto;
                            padding: 20mm; /* A4 margins */
                            box-sizing: border-box; /* Include padding in width */
                        }
                        h1, h2, h3, h4, h5, h6 {
                            color: #000000 !important;
                            margin-top: 1.5em;
                            margin-bottom: 0.5em;
                            page-break-after: avoid;
                            font-weight: bold;
                        }
                        h1 { font-size: 24pt; }
                        h2 { font-size: 18pt; }
                        h3 { font-size: 14pt; }
                        p, ul, ol, table {
                            margin-bottom: 1em;
                            line-height: 1.4;
                            page-break-inside: avoid;
                        }
                        strong { font-weight: bold; }
                        em { font-style: italic; }
                        ul, ol {
                            padding-left: 2em;
                        }
                        li {
                            margin-bottom: 0.5em;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 1.5em;
                            border: 1px solid #ccc;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 0.6em 0.8em;
                            text-align: left;
                        }
                        thead tr {
                            background-color: #f0f0f0 !important;
                            color: #000000 !important;
                        }
                        tbody tr:nth-child(odd) {
                            background-color: #f7fafc !important; /* zebra striping */
                        }
                        img {
                            max-width: 95% !important;
                            height: auto !important;
                            display: block;
                            margin: 1em auto;
                            box-shadow: none !important;
                            border: 1px solid #eee;
                            page-break-inside: avoid; /* Keep image on one page */
                        }
                        .note-caution, .note-warning {
                            border: 1px solid #ccc;
                            border-left: 5px solid;
                            padding: 1em 1.2em;
                            margin-bottom: 1.5em;
                            page-break-inside: avoid;
                            background-color: #f8f8f8 !important;
                            color: #000000 !important;
                            border-radius: 5px;
                        }
                        .note-caution { border-left-color: #f6ad55 !important; }
                        .note-warning { border-left-color: #ef4444 !important; }

                        /* Hotspot links should show their target ID in print */
                        .hotspot-link {
                            text-decoration: underline; /* Keep underline for print */
                            color: #000000; /* Black text for print */
                        }
                        .hotspot-link::after {
                            content: " (ID: " attr(data-hotspot) ")";
                            font-size: 90%;
                            color: #555;
                            word-break: break-all;
                        }
                        /* Annotated text highlight - should be removed in print or just show as normal text */
                        .annotated-text {
                            background-color: transparent !important;
                            border-bottom: none !important;
                            cursor: default !important;
                        }
                        .annotation-tooltip {
                            display: none !important; /* Hide tooltips in print */
                        }
                        /* Ensure no elements outside .print-container are visible */
                        body > *:not(.print-container) {
                            display: none !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        ${contentToPrintHtml}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close(); // Close the document to ensure content is rendered

            // Wait for content and styles to load before printing
            printWindow.onload = function () {
                printWindow.focus(); // Focus the new window
                printWindow.print();
                printWindow.close(); // Close after printing
            };
        }

        /**
         * Initiates downloading of the current module's content as an HTML file (User-facing).
         * This function triggers a download to the user's local file system.
         * The exact "location" (folder) is chosen by the user via their browser's download prompt.
         */
        function downloadCurrentContent() {
            if (selectedModuleId) {
                const module = dataModules.find(dm => dm.id === selectedModuleId);
                if (!module) {
                    displayTemporaryMessage('Selected module not found for download.', 'error');
                    return;
                }

                let contentToDownload = '';
                let filename = `${module.title.replace(/[^a-zA-Z0-9-]/g, '_')}.html`; // Default user filename

                // Users always download the formatted XML content as HTML
                try {
                    contentToDownload = renderXmlAsHtml(module.xmlContent);
                } catch (e) {
                    displayTemporaryMessage(`Error preparing XML for download: ${e.message}`, 'error');
                    return;
                }

                if (!contentToDownload) {
                    displayTemporaryMessage('No content available for download.', 'info');
                    return;
                }

                // Display a temporary message indicating the download is starting and
                // explaining browser's role in choosing save location, similar to user's snippet.
                displayTemporaryMessage('Download initiated. Your browser will prompt you to choose a save location.', 'info');


                // Create a Blob from the content
                const blob = new Blob([contentToDownload], { type: 'text/html' });
                const url = URL.createObjectURL(blob);

                // Create a temporary anchor element and trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = filename; // This sets the suggested filename
                document.body.appendChild(a); // Append to body for Firefox compatibility
                a.click(); // Programmatically click the anchor to trigger download
                document.body.removeChild(a); // Clean up the temporary element
                URL.revokeObjectURL(url); // Release the object URL

                // A success message after a slight delay, to allow time for the browser's download prompt.
                // This is optional, as the browser's own UI handles download success.
                setTimeout(() => {
                    displayTemporaryMessage(`Downloaded "${filename}".`, 'success');
                }, 1000); // 1 second delay
            } else {
                displayTemporaryMessage('No content selected to download.', 'info');
            }
        }

        /**
         * Initiates downloading of the current module's raw HTML content (Admin-only).
         * This function triggers a download to the user's local file system.
         * The exact "location" (folder) is chosen by the user via their browser's download prompt.
         */
        function downloadRawHtml() {
            if (!selectedModuleId) {
                displayTemporaryMessage('No module selected to download raw HTML.', 'info');
                return;
            }
            const module = dataModules.find(dm => dm.id === selectedModuleId);
            if (!module || !module.content) {
                displayTemporaryMessage('No raw HTML content available for this module.', 'info');
                return;
            }

            const filename = `${module.title.replace(/[^a-zA-Z0-9-]/g, '_')}_raw.html`;
            const blob = new Blob([module.content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            displayTemporaryMessage(`Downloaded raw HTML: "${filename}".`, 'success');
        }

        /**
         * Initiates saving of the current module's raw XML content using File System Access API (Admin-only).
         * This function opens a native "Save As" dialog, letting the user choose the save location.
         */
        async function downloadRawXml() {
            if (!selectedModuleId) {
                displayTemporaryMessage('No module selected to save raw XML.', 'info');
                return;
            }
            const module = dataModules.find(dm => dm.id === selectedModuleId);
            if (!module || !module.xmlContent) {
                displayTemporaryMessage('No raw XML content available for this module.', 'info');
                return;
            }

            // Check if File System Access API is supported
            if ('showSaveFilePicker' in window) {
                try {
                    const xmlContent = module.xmlContent;
                    const filename = `${module.title.replace(/[^a-zA-Z0-9-]/g, '_')}_raw.xml`;

                    const options = {
                        suggestedName: filename,
                        types: [{
                            description: 'XML Files',
                            accept: {
                                'text/xml': ['.xml'],
                                'application/xml': ['.xml']
                            },
                        }],
                    };

                    const handle = await window.showSaveFilePicker(options);
                    const writableStream = await handle.createWritable();
                    await writableStream.write(xmlContent);
                    await writableStream.close();

                    displayTemporaryMessage(`Saved raw XML: "${filename}" to your chosen location.`, 'success');

                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.log('User cancelled the save operation.');
                        displayTemporaryMessage('XML save cancelled by user.', 'info');
                    } else {
                        console.error('Error saving XML file:', err);
                        displayTemporaryMessage(`Failed to save XML file: ${err.message}.`, 'error');
                    }
                }
            } else {
                // Fallback for browsers that do not support showSaveFilePicker
                displayTemporaryMessage('Your browser does not fully support direct "Save As" for XML. Initiating regular download.', 'info');
                const filename = `${module.title.replace(/[^a-zA-Z0-9-]/g, '_')}_raw.xml`;
                const blob = new Blob([module.xmlContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        /**
         * Displays a temporary message in the content area for user feedback.
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', or 'info'.
         */
        function displayTemporaryMessage(message, type = 'info') {
            const tempMessageDiv = document.createElement('div');
            tempMessageDiv.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg text-white text-sm z-50`;
            if (type === 'success') {
                tempMessageDiv.classList.add('bg-green-500');
            } else if (type === 'error') {
                tempMessageDiv.classList.add('bg-red-500');
            } else {
                tempMessageDiv.classList.add('bg-blue-500');
            }
            tempMessageDiv.textContent = message;
            document.body.appendChild(tempMessageDiv);

            setTimeout(() => {
                tempMessageDiv.remove();
            }, 3000); // Remove after 3 seconds
        }

        /**
         * Displays a custom alert message box instead of `window.alert()`.
         * @param {string} message The message to display.
         */
        function displayAlertMessageBox(message) {
            const overlay = document.createElement('div');
            overlay.className = 'message-box-overlay';
            overlay.innerHTML = `
                <div class="message-box">
                    <p>${message}</p>
                    <div class="message-box-buttons">
                        <button class="alert-btn" id="alertOkBtn">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            document.getElementById('alertOkBtn').addEventListener('click', () => {
                overlay.remove();
            });
        }

        /**
         * Displays a custom confirmation message box instead of `window.confirm()`.
         * @param {string} message The confirmation message.
         * @param {function} onConfirm Callback function if user confirms.
         * @param {function} onCancel Callback function if user cancels (optional).
         */
        function displayConfirmMessageBox(message, onConfirm, onCancel = () => { }) {
            const overlay = document.createElement('div');
            overlay.className = 'message-box-overlay';
            overlay.innerHTML = `
                <div class="message-box">
                    <p>${message}</p>
                    <div class="message-box-buttons">
                        <button class="confirm-btn" id="confirmYesBtn">Yes</button>
                        <button class="cancel-btn" id="confirmNoBtn">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            document.getElementById('confirmYesBtn').addEventListener('click', () => {
                overlay.remove();
                onConfirm();
            });

            document.getElementById('confirmNoBtn').addEventListener('click', () => {
                overlay.remove();
                onCancel();
            });
        }

        // Override native alert and confirm (optional but good practice for consistent UI)
        window.alert = displayAlertMessageBox;
        window.confirm = displayConfirmMessageBox;


        // --- Authentication Functions ---

        /**
         * Logs in a user based on provided credentials.
         * @param {string} username
         * @param {string} password
         * @returns {boolean} True if login successful, false otherwise.
         */
        function login(username, password) {
            if (USERS[username] && USERS[username].password === password) {
                currentUser = { username, role: USERS[username].role };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                return true;
            }
            return false;
        }

        /**
         * Logs out the current user.
         */
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        /**
         * Displays the login screen and hides the app.
         */
        function showLoginScreen() {
            loginContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loginError.classList.add('hidden'); // Clear error
            usernameInput.value = '';
            passwordInput.value = '';
        }

        /**
         * Displays the app screen and hides the login.
         */
        function showAppScreen() {
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userInfo.textContent = `Hi, ${currentUser.username} (${currentUser.role.toUpperCase()})`;

            // Set the app title based on the user's role
            if (currentUser.role === 'admin') {
                appTitle.textContent = 'IETM Author';
                adminControls.classList.remove('hidden');
            } else {
                appTitle.textContent = 'IETM Viewer';
                adminControls.classList.add('hidden');
                moduleFormContainer.classList.add('hidden'); // Ensure form is hidden for users
            }

            renderModuleList(); // Render modules for the logged-in user
            populateQuickAccessDropdown(); // Populate quick access dropdown

            // Try to select the first module or first project, or show empty message
            if (dataModules.length > 0) {
                const firstModule = dataModules.find(m => m.level === 0) || dataModules[0];
                handleModuleSelect(firstModule.id);
            } else {
                contentDisplay.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 text-lg text-center p-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open text-blue-400 mb-6"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <p class="text-xl font-medium text-gray-600">Welcome to your IETM Dashboard!</p>
                    <p class="mt-2 text-gray-500 max-w-prose">${currentUser.role === 'admin' ? 'As an admin, you can start by adding a new project using the "Add New Project" button below.' : 'Please contact an administrator to add content.'}</p>
                </div>`;
            }
            updateNavigationButtons(); // Initial state of buttons
        }

        /**
         * Initializes the application based on login status.
         */
        function initializeApp() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showAppScreen();
            } else {
                showLoginScreen();
            }
        }

        // --- HTML to XML Conversion (for Admin input) ---

        /**
         * Converts a simplified HTML string into a custom XML format.
         * This is a basic conversion and may not handle all complex HTML structures.
         * @param {string} htmlString The HTML content to convert.
         * @returns {string} The converted XML string.
         */
        function convertHtmlToSimpleXml(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${htmlString}</div>`, 'text/html');
            const root = doc.body.firstChild; // The div wrapper

            let xmlOutput = '<?xml version="1.0" encoding="UTF-8"?>\n<module>\n';

            // Add image and hotspots directly under <module> if they exist
            const currentModuleData = dataModules.find(m => m.id === moduleIdInput.value);
            if (currentModuleData && currentModuleData.imageUrl) {
                xmlOutput += `    <image src="${currentModuleData.imageUrl}" alt="Module Image"/>\n`;
                if (currentModuleData.hotspots && currentModuleData.hotspots.length > 0) {
                    xmlOutput += `    <hotspots>\n`;
                    currentModuleData.hotspots.forEach(hs => {
                        xmlOutput += `        <hotspot x="${hs.x}" y="${hs.y}" width="${hs.width}" height="${hs.height}" target="${hs.targetModuleId}"`;
                        if (hs.tooltip) {
                            xmlOutput += ` tooltip="${hs.tooltip}"`;
                        }
                        xmlOutput += `/>\n`;
                    });
                    xmlOutput += `    </hotspots>\n`;
                }
            }


            xmlOutput += '    <title>Module Title Placeholder</title>\n    <content>\n';

            // Function to process nodes recursively
            const processNode = (node, indentLevel = 2) => {
                let nodeXml = '';
                const indent = ' '.repeat(indentLevel * 4); // 4 spaces per indent level

                if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    // const attributes = Array.from(node.attributes).map(attr => `${attr.name}="${attr.value}"`).join(' '); // Not directly used in current XML schema

                    switch (tagName) {
                        case 'h1':
                        case 'h2':
                        case 'h3':
                            nodeXml += `${indent}<heading level="${tagName.substring(1)}">`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `</heading>\n`;
                            break;
                        case 'p':
                            nodeXml += `${indent}<paragraph>`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `</paragraph>\n`;
                            break;
                        case 'strong':
                        case 'b':
                            nodeXml += `<bold>`;
                            nodeXml += processChildren(node, indentLevel + 1, false); // No newline for inline
                            nodeXml += `</bold>`;
                            break;
                        case 'em':
                        case 'i':
                            nodeXml += `<italic>`;
                            nodeXml += processChildren(node, indentLevel + 1, false); // No newline for inline
                            nodeXml += `</italic>`;
                            break;
                        case 'ul':
                        case 'ol':
                            nodeXml += `${indent}<list type="${tagName === 'ul' ? 'unordered' : 'ordered'}">\n`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `${indent}</list>\n`;
                            break;
                        case 'li':
                            nodeXml += `${indent}<item>`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `</item>\n`;
                            break;
                        case 'span': // Handle hotspots and annotations
                            if (node.hasAttribute('data-hotspot')) {
                                nodeXml += `<link target="${node.getAttribute('data-hotspot')}">`;
                                nodeXml += processChildren(node, indentLevel + 1, false);
                                nodeXml += `</link>`;
                            } else if (node.classList.contains('annotated-text')) {
                                // Extract annotation data from attributes and create <annotation> XML
                                const annotationText = node.dataset.annotationText;
                                const annotationAnnotator = node.dataset.annotationAnnotator;
                                const annotationTimestamp = node.dataset.annotationTimestamp;
                                const annotationId = node.dataset.annotationId;

                                if (annotationText && annotationId) {
                                    nodeXml += `<annotation id="${annotationId}" text="${escapeXmlAttribute(annotationText)}" annotator="${escapeXmlAttribute(annotationAnnotator)}" timestamp="${annotationTimestamp}">`;
                                    nodeXml += processChildren(node, indentLevel + 1, false); // Content of the annotation tag is the highlighted text
                                    nodeXml += `</annotation>`;
                                } else {
                                    nodeXml += processChildren(node, indentLevel + 1, false); // Just process children if invalid annotation
                                }
                            } else {
                                nodeXml += processChildren(node, indentLevel + 1, false); // Just process children if not hotspot or annotation
                            }
                            break;
                        case 'img': // Inline images within content
                            const src = node.getAttribute('src') || '';
                            const alt = node.getAttribute('alt') || 'Image';
                            nodeXml += `${indent}<inline_image src="${src}" alt="${alt}"/>\n`; // Changed to inline_image
                            break;
                        case 'table':
                            nodeXml += `${indent}<table_data>\n`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `${indent}</table_data>\n`;
                            break;
                        case 'thead':
                        case 'tbody':
                            nodeXml += `${indent}<${tagName}>\n`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `${indent}</${tagName}>\n`;
                            break;
                        case 'tr':
                            nodeXml += `${indent}<tr>\n`;
                            nodeXml += processChildren(node, indentLevel + 1);
                            nodeXml += `${indent}</tr>\n`;
                            break;
                        case 'th':
                        case 'td':
                            nodeXml += `${indent}<${tagName}>`;
                            nodeXml += processChildren(node, indentLevel + 1, false);
                            nodeXml += `</${tagName}>\n`;
                            break;
                        case 'div': // Special handling for notes/alerts
                            if (node.getAttribute('role') === 'alert') {
                                let type = 'info';
                                if (node.classList.contains('bg-yellow-100')) type = 'caution';
                                if (node.classList.contains('bg-red-100')) type = 'warning';
                                nodeXml += `${indent}<note type="${type}">\n`;
                                nodeXml += processChildren(node, indentLevel + 1);
                                nodeXml += `${indent}</note>\n`;
                            } else {
                                // Default for other divs, just process children
                                nodeXml += processChildren(node, indentLevel, false); // No wrapper tag
                            }
                            break;
                        case 'hr': // Horizontal rule
                            nodeXml += `${indent}<hr/>\n`;
                            break;
                        default:
                            // Fallback for unrecognized block-level elements or just process children
                            nodeXml += processChildren(node, indentLevel, false);
                            break;
                    }
                } else if (node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0) {
                    nodeXml += escapeHtml(node.textContent.trim()); // Escape text content
                }
                return nodeXml;
            };

            // Helper to process children nodes
            const processChildren = (parentNode, indentLevel, blockLevel = true) => {
                let childrenXml = '';
                parentNode.childNodes.forEach(child => {
                    childrenXml += processNode(child, blockLevel ? indentLevel : 0); // No extra indent for inline
                });
                return childrenXml;
            };

            xmlOutput += processChildren(root);
            xmlOutput += '    </content>\n</module>';
            return xmlOutput;
        }

        /**
         * Escapes a string for use as an XML attribute value.
         * @param {string} str The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeXmlAttribute(str) {
            return str.replace(/[<>&"']/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '"': return '&quot;';
                    case "'": return '&apos;';
                }
            });
        }


        /**
         * Renders XML content as HTML elements.
         * This function expects a specific XML structure generated by `convertHtmlToSimpleXml`.
         * @param {string} xmlString The XML content to render.
         * @returns {string} The HTML string.
         */
        function renderXmlAsHtml(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'application/xml');

            // Check for parsing errors
            if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                console.error("XML parsing error:", xmlDoc.getElementsByTagName('parsererror')[0]);
                // Fallback or error message for user
                return `<p class="text-red-500 font-semibold">Error parsing XML content. Please check the XML syntax.</p><pre>${escapeHtml(xmlString)}</pre>`;
            }

            const contentNode = xmlDoc.querySelector('module > content');
            if (!contentNode) {
                return '<p class="text-gray-500 italic">No content found in XML module.</p>';
            }

            let htmlOutput = '';

            const traverseAndRender = (node) => {
                let nodeHtml = '';
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    switch (tagName) {
                        case 'heading':
                            const level = node.getAttribute('level') || '2'; // Default to h2
                            nodeHtml += `<h${level}>${traverseAndRenderChildren(node)}</h${level}>`;
                            break;
                        case 'paragraph':
                            nodeHtml += `<p>${traverseAndRenderChildren(node)}</p>`;
                            break;
                        case 'bold':
                            nodeHtml += `<strong>${traverseAndRenderChildren(node)}</strong>`;
                            break;
                        case 'italic':
                            nodeHtml += `<em>${traverseAndRenderChildren(node)}</em>`;
                            break;
                        case 'list':
                            const listType = node.getAttribute('type') === 'ordered' ? 'ol' : 'ul';
                            nodeHtml += `<${listType}>${traverseAndRenderChildren(node)}</${listType}>`;
                            break;
                        case 'item':
                            nodeHtml += `<li>${traverseAndRenderChildren(node)}</li>`;
                            break;
                        case 'link':
                            const target = node.getAttribute('target');
                            nodeHtml += `<span class="hotspot-link" data-hotspot="${target}">${traverseAndRenderChildren(node)}</span>`;
                            break;
                        case 'inline_image': // Render inline images in content
                            const src = node.getAttribute('src');
                            const alt = node.getAttribute('alt');
                            nodeHtml += `
                                <div class="image-container">
                                    <img src="${src}" alt="${alt}" onerror="this.onerror=null;this.src='https://placehold.co/600x300/CCCCCC/666666?text=Image+Failed+to+Load';" class="max-w-full h-auto rounded-lg">
                                    <button class="image-download-btn" title="Download Image" data-image-src="${src}" data-image-alt="${alt.replace(/[^a-zA-Z0-9]/g, '_')}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                    </button>
                                </div>
                            `;
                            break;
                        case 'table_data':
                            nodeHtml += `<table>${traverseAndRenderChildren(node)}</table>`;
                            break;
                        case 'thead':
                            nodeHtml += `<thead>${traverseAndRenderChildren(node)}</thead>`;
                            break;
                        case 'tbody':
                            nodeHtml += `<tbody>${traverseAndRenderChildren(node)}</tbody>`;
                            break;
                        case 'tr':
                            nodeHtml += `<tr>${traverseAndRenderChildren(node)}</tr>`;
                            break;
                        case 'th':
                            nodeHtml += `<th>${traverseAndRenderChildren(node)}</th>`;
                            break;
                        case 'td':
                            nodeHtml += `<td>${traverseAndRenderChildren(node)}</td>`;
                            break;
                        case 'note':
                            const noteType = node.getAttribute('type');
                            let noteClass = 'note-info'; // Default
                            if (noteType === 'caution') noteClass = 'note-caution';
                            if (noteType === 'warning') noteClass = 'note-warning';
                            nodeHtml += `<div class="${noteClass}" role="alert">${traverseAndRenderChildren(node)}</div>`;
                            break;
                        case 'hr':
                            nodeHtml += `<hr>`;
                            break;
                        case 'annotation':
                            // Render annotation as highlighted text with tooltip
                            const annotationId = node.getAttribute('id');
                            const annotationText = node.getAttribute('text');
                            const annotationAnnotator = node.getAttribute('annotator');
                            const annotationTimestamp = node.getAttribute('timestamp');
                            const formattedTimestamp = new Date(annotationTimestamp).toLocaleString();
                            nodeHtml += `
                                <span class="annotated-text" 
                                    data-annotation-id="${annotationId}"
                                    data-annotation-text="${escapeHtml(annotationText)}" 
                                    data-annotation-annotator="${escapeHtml(annotationAnnotator)}"
                                    data-annotation-timestamp="${annotationTimestamp}"
                                    >
                                    ${traverseAndRenderChildren(node)}
                                    <span class="annotation-tooltip">
                                        ${escapeHtml(annotationText)}
                                        <span class="annotation-tooltip-meta">
                                            By ${escapeHtml(annotationAnnotator)} on ${formattedTimestamp}
                                            ${currentUser && currentUser.role === 'admin' ?
                                    `<button class="annotation-tooltip-delete" data-annotation-id="${annotationId}" title="Delete Annotation">Delete</button>` : ''
                                }
                                        </span>
                                    </span>
                                </span>`;
                            break;
                        case 'content': // Top-level content wrapper, just process children
                            nodeHtml += traverseAndRenderChildren(node);
                            break;
                        case 'image': // Main module image - handled by renderContent directly
                        case 'hotspots': // Hotspots - handled by renderContent directly
                            break;
                        default:
                            // For unknown elements, try to render their children
                            nodeHtml += traverseAndRenderChildren(node);
                            break;
                    }
                } else if (node.nodeType === Node.TEXT_NODE) {
                    nodeHtml += escapeHtml(node.textContent); // Escape text content
                }
                return nodeHtml;
            };

            const traverseAndRenderChildren = (parentNode) => {
                let childrenHtml = '';
                parentNode.childNodes.forEach(child => {
                    childrenHtml += traverseAndRender(child);
                });
                return childrenHtml;
            };

            htmlOutput = traverseAndRender(contentNode);
            return htmlOutput;
        }

        /**
         * Updates the XML content textarea based on changes in the HTML content textarea.
         * This function converts the HTML input to XML for the user view.
         */
        function updateXmlContent() {
            try {
                const htmlContent = moduleContentInput.value;
                const xmlContent = convertHtmlToSimpleXml(htmlContent);
                xmlModuleContentInput.value = xmlContent;
            } catch (error) {
                console.error("Error converting HTML to XML:", error);
                xmlModuleContentInput.value = `<!-- Error converting HTML to XML: ${error.message} -->`;
            }
        }


        // --- Hotspot Editor Logic ---
        let currentDrawingHotspot = null; // Stores { x, y, width, height } in pixels
        let initialMouseX, initialMouseY;
        const ctx = hotspotCanvas.getContext('2d');

        /**
         * Opens the hotspot editor modal and initializes it with current image and hotspots.
         */
        function openHotspotEditor() {
            const module = dataModules.find(m => m.id === moduleIdInput.value);
            if (!module || !module.imageUrl) {
                displayTemporaryMessage('Please upload a primary image first to define hotspots.', 'info');
                return;
            }

            hotspotEditorImage.src = module.imageUrl;
            currentHotspots = JSON.parse(JSON.stringify(module.hotspots || [])); // Deep copy for editing

            hotspotEditorModal.classList.remove('hidden');
            populateHotspotTargetSelect(); // Populate dropdown for linking modules
            renderDefinedHotspotsList(); // Populate list of defined hotspots

            // Ensure canvas matches image dimensions once image loads
            hotspotEditorImage.onload = () => {
                resizeCanvasToImage();
                drawHotspotsOnCanvas(); // Draw initial hotspots on canvas
            };
            // If image is already loaded (e.g., from cache), trigger directly
            if (hotspotEditorImage.complete && hotspotEditorImage.naturalHeight !== 0) {
                resizeCanvasToImage();
                drawHotspotsOnCanvas();
            }

            // Reset current drawing state
            drawingRect = null;
            isDrawing = false;
            hotspotTargetSelect.value = '';
            hotspotTooltipInput.value = '';
            addHotspotBtn.disabled = true; // Disable until a rectangle is drawn
            saveHotspotsBtn.disabled = false; // Enable saving even if no new hotspots added
        }

        /**
         * Resizes the canvas to match the dimensions of the hotspot editor image.
         */
        function resizeCanvasToImage() {
            hotspotCanvas.width = hotspotEditorImage.offsetWidth;
            hotspotCanvas.height = hotspotEditorImage.offsetHeight;
            ctx.clearRect(0, 0, hotspotCanvas.width, hotspotCanvas.height); // Clear canvas after resize
        }

        /**
         * Draws all currently defined hotspots (currentHotspots) and the rect being drawn.
         * Also renders clickable overlays in `hotspotCanvasOverlays` for selection/deletion.
         */
        function drawHotspotsOnCanvas() {
            ctx.clearRect(0, 0, hotspotCanvas.width, hotspotCanvas.height); // Clear existing drawings

            // Render existing hotspots (solid borders)
            currentHotspots.forEach((hs, index) => {
                const xPx = hs.x / 100 * hotspotCanvas.width;
                const yPx = hs.y / 100 * hotspotCanvas.height;
                const widthPx = hs.width / 100 * hotspotCanvas.width;
                const heightPx = hs.height / 100 * hotspotCanvas.height;

                ctx.strokeStyle = '#007bff'; // Blue
                ctx.lineWidth = 2;
                ctx.strokeRect(xPx, yPx, widthPx, heightPx);

                // Add a small label for the hotspot number
                ctx.fillStyle = '#007bff';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`${index + 1}`, xPx + 5, yPx + 15);
            });

            // Render the currently drawing rectangle (dashed border)
            if (drawingRect) {
                const { startX, startY, currentX, currentY } = drawingRect;
                const x = Math.min(startX, currentX);
                const y = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);

                ctx.setLineDash([5, 5]); // Dashed line
                ctx.strokeStyle = '#dc2626'; // Red
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
                ctx.setLineDash([]); // Reset to solid line for next drawings
            }
            renderHotspotEditorOverlays(); // Update clickable overlays
        }

        /**
         * Renders clickable HTML elements over the canvas for existing hotspots to allow selection/deletion.
         */
        function renderHotspotEditorOverlays() {
            hotspotCanvasOverlays.innerHTML = ''; // Clear existing overlays

            currentHotspots.forEach((hs, index) => {
                const overlayDiv = document.createElement('div');
                overlayDiv.className = 'absolute border border-transparent hover:border-blue-500 rounded-md';
                overlayDiv.style.left = `${hs.x}%`;
                overlayDiv.style.top = `${hs.y}%`;
                overlayDiv.style.width = `${hs.width}%`;
                overlayDiv.style.height = `${hs.height}%`;
                overlayDiv.style.cursor = 'pointer';
                overlayDiv.style.zIndex = '10'; // Ensure it's above the image, below drawing canvas
                overlayDiv.title = `Hotspot ${index + 1}: ${dataModules.find(m => m.id === hs.targetModuleId)?.title || hs.targetModuleId}`;

                // Add event listener for selecting an existing hotspot (optional: for editing later)
                overlayDiv.addEventListener('click', () => {
                    // For now, just logging. Could be expanded to select this hotspot in UI for editing.
                    console.log('Clicked existing hotspot:', hs);
                });

                hotspotCanvasOverlays.appendChild(overlayDiv);
            });
        }


        hotspotCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            addHotspotBtn.disabled = true; // Disable add button while drawing
            const rect = hotspotCanvas.getBoundingClientRect();
            initialMouseX = e.clientX - rect.left;
            initialMouseY = e.clientY - rect.top;
            drawingRect = {
                startX: initialMouseX,
                startY: initialMouseY,
                currentX: initialMouseX,
                currentY: initialMouseY
            };
        });

        hotspotCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = hotspotCanvas.getBoundingClientRect();
            drawingRect.currentX = e.clientX - rect.left;
            drawingRect.currentY = e.clientY - rect.top;
            drawHotspotsOnCanvas(); // Redraw with the new rectangle
        });

        hotspotCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
            if (drawingRect) {
                const { startX, startY, currentX, currentY } = drawingRect;
                const minX = Math.min(startX, currentX);
                const minY = Math.min(startY, currentY);
                const maxX = Math.max(startX, currentX);
                const maxY = Math.max(startY, currentY);

                const widthPx = maxX - minX;
                const heightPx = maxY - minY;

                // Only enable add button if a meaningful rectangle was drawn
                if (widthPx > 5 && heightPx > 5) { // Minimum size for a valid hotspot
                    addHotspotBtn.disabled = false;
                } else {
                    addHotspotBtn.disabled = true;
                }
            }
            drawHotspotsOnCanvas(); // Final draw without the "drawing" state
        });

        // Handle canvas resize
        window.addEventListener('resize', () => {
            if (!hotspotEditorModal.classList.contains('hidden')) {
                resizeCanvasToImage();
                drawHotspotsOnCanvas();
            }
        });


        /**
         * Adds the currently drawn rectangle as a new hotspot to the `currentHotspots` array.
         */
        function addCurrentHotspot() {
            if (!drawingRect || addHotspotBtn.disabled) {
                displayTemporaryMessage('Please draw a valid hotspot area first.', 'error');
                return;
            }
            if (!hotspotTargetSelect.value) {
                displayTemporaryMessage('Please select a target module for the hotspot.', 'error');
                return;
            }

            const { startX, startY, currentX, currentY } = drawingRect;
            const xPx = Math.min(startX, currentX);
            const yPx = Math.min(startY, currentY);
            const widthPx = Math.abs(currentX - startX);
            const heightPx = Math.abs(currentY - startY);

            // Convert pixel coordinates to percentages
            const xPercent = (xPx / hotspotCanvas.width) * 100;
            const yPercent = (yPx / hotspotCanvas.height) * 100;
            const widthPercent = (widthPx / hotspotCanvas.width) * 100;
            const heightPercent = (heightPx / hotspotCanvas.height) * 100;

            currentHotspots.push({
                x: parseFloat(xPercent.toFixed(2)),
                y: parseFloat(yPercent.toFixed(2)),
                width: parseFloat(widthPercent.toFixed(2)),
                height: parseFloat(heightPercent.toFixed(2)),
                targetModuleId: hotspotTargetSelect.value,
                tooltip: hotspotTooltipInput.value.trim()
            });

            drawingRect = null; // Clear drawing state
            addHotspotBtn.disabled = true; // Disable add button
            hotspotTargetSelect.value = ''; // Clear selection
            hotspotTooltipInput.value = ''; // Clear tooltip
            drawHotspotsOnCanvas(); // Redraw canvas
            renderDefinedHotspotsList(); // Update the list
            displayTemporaryMessage('Hotspot added!', 'success');
        }

        /**
         * Renders the list of defined hotspots in the modal.
         */
        function renderDefinedHotspotsList() {
            definedHotspotsList.innerHTML = '';
            hotspotCount.textContent = currentHotspots.length;

            if (currentHotspots.length === 0) {
                noDefinedHotspotsMsg.classList.remove('hidden');
            } else {
                noDefinedHotspotsMsg.classList.add('hidden'); // Ensure it's hidden if there are items
                currentHotspots.forEach((hs, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between p-2 mb-2 bg-white rounded-md shadow-sm text-gray-700 text-sm border border-gray-100';

                    const targetModule = dataModules.find(m => m.id === hs.targetModuleId);
                    const targetTitle = targetModule ? (targetModule.serialNumber ? `${targetModule.serialNumber}. ` : '') + targetModule.title : hs.targetModuleId;
                    const tooltipText = hs.tooltip ? ` ("${hs.tooltip}")` : '';

                    listItem.innerHTML = `
                        <span>
                            <strong>Hotspot ${index + 1}:</strong> Link to "${targetTitle}"${tooltipText}
                            <br>
                            <span class="text-xs text-gray-500">
                                (X: ${hs.x}%, Y: ${hs.y}%, W: ${hs.width}%, H: ${hs.height}%)
                            </span>
                        </span>
                        <button class="text-red-500 hover:text-red-700 p-1 rounded-full delete-hotspot-btn" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    `;
                    definedHotspotsList.appendChild(listItem);
                });

                // Attach event listeners for delete buttons
                definedHotspotsList.querySelectorAll('.delete-hotspot-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDelete = parseInt(e.currentTarget.dataset.index);
                        displayConfirmMessageBox(`Delete Hotspot ${indexToDelete + 1}?`, () => {
                            currentHotspots.splice(indexToDelete, 1);
                            drawHotspotsOnCanvas();
                            renderDefinedHotspotsList();
                            displayTemporaryMessage('Hotspot deleted.', 'success');
                        });
                    });
                });
            }
        }

        /**
         * Saves the current `currentHotspots` array to the module being edited.
         */
        function saveHotspotsToModule() {
            const moduleIndex = dataModules.findIndex(m => m.id === moduleIdInput.value);
            if (moduleIndex !== -1) {
                dataModules[moduleIndex].hotspots = JSON.parse(JSON.stringify(currentHotspots)); // Deep copy
                saveModules();
                displayTemporaryMessage('Hotspots saved successfully!', 'success');
            } else {
                displayTemporaryMessage('Error: Module not found to save hotspots.', 'error');
            }
            hotspotEditorModal.classList.add('hidden');
        }

        /**
         * Closes the hotspot editor without saving changes to the current module.
         */
        function cancelHotspotEditing() {
            displayTemporaryMessage('Hotspot editing cancelled.', 'info');
            hotspotEditorModal.classList.add('hidden');
            // currentHotspots is automatically reset when opening the editor again
        }

        // --- Annotation Functions (Revised) ---

        /**
         * Generates a simple unique ID for an annotation.
         * @returns {string} Unique annotation ID.
         */
        function generateAnnotationId() {
            uniqueAnnotationCounter++;
            return `annot-${Date.now().toString().slice(-8)}-${uniqueAnnotationCounter}`;
        }

        /**
         * Handles text selection in the content area for annotation.
         * Opens the annotation modal if text is selected (Admin only).
         */
        function handleTextSelection() {
            if (currentUser && currentUser.role === 'admin') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const selectedText = range.toString().trim();

                    // Ensure selected text is not empty and is within the #readableContent div
                    const readableContentDiv = contentDisplay.querySelector('#readableContent');
                    if (selectedText.length > 0 && readableContentDiv.contains(range.commonAncestorContainer)) {
                        selectedRange = range; // Store the range globally
                        highlightedTextPreview.textContent = selectedText;
                        annotationTextarea.value = ''; // Clear previous annotation text
                        annotationModal.classList.remove('hidden');
                        annotationTextarea.focus();
                    } else {
                        selectedRange = null; // Clear if selection is invalid
                    }
                }
            }
        }


        /**
         * Saves a new annotation to the currently selected module, highlighting the selected text.
         * @param {Event} event The form submission event.
         */
        function saveAnnotation(event) {
            event.preventDefault();
            const annotationText = annotationTextarea.value.trim();

            if (!selectedRange || !annotationText) {
                displayTemporaryMessage('No text selected or annotation text is empty.', 'error');
                return;
            }

            const moduleIndex = dataModules.findIndex(m => m.id === selectedModuleId);
            if (moduleIndex === -1) {
                displayTemporaryMessage('Error: Selected module not found.', 'error');
                return;
            }

            const uniqueId = generateAnnotationId(); // Generate a unique ID for this annotation
            const annotator = currentUser ? currentUser.username : 'Guest';
            const timestamp = new Date().toISOString();

            // Store annotation data in module's annotations array
            const moduleToUpdate = dataModules[moduleIndex];
            if (!moduleToUpdate.annotations) {
                moduleToUpdate.annotations = [];
            }
            moduleToUpdate.annotations.push({
                id: uniqueId,
                text: annotationText,
                annotator: annotator,
                timestamp: timestamp,
                originalText: selectedRange.toString() // Store original text for reference
            });

            // Wrap the selected text with a span and add annotation data as data attributes
            const span = document.createElement('span');
            span.classList.add('annotated-text');
            span.dataset.annotationId = uniqueId;
            span.dataset.annotationText = annotationText;
            span.dataset.annotationAnnotator = annotator;
            span.dataset.annotationTimestamp = timestamp;

            try {
                selectedRange.surroundContents(span);
            } catch (e) {
                console.error("Error surrounding contents with span for annotation:", e);
                displayTemporaryMessage('Failed to apply annotation. Try selecting a continuous block of text.', 'error');
                // Revert annotation data if highlight failed
                moduleToUpdate.annotations = moduleToUpdate.annotations.filter(a => a.id !== uniqueId);
                annotationModal.classList.add('hidden');
                selectedRange = null;
                return;
            }

            // Update the module's HTML content from the DOM after highlighting
            moduleToUpdate.content = contentDisplay.querySelector('#readableContent').innerHTML;

            // Trigger XML conversion and save module data
            moduleToUpdate.xmlContent = convertHtmlToSimpleXml(moduleToUpdate.content);
            saveModules();
            addHistoryEntry('annotate', moduleToUpdate.id, moduleToUpdate.title, `Added annotation to content of "${moduleToUpdate.title}".`);
            displayTemporaryMessage('Annotation added successfully!', 'success');

            annotationModal.classList.add('hidden');
            selectedRange = null; // Clear selected range after use
            window.getSelection().empty(); // Clear browser selection
        }

        /**
         * Deletes an annotation based on its ID.
         * This function needs to remove the annotation from the module's data
         * AND remove the corresponding `annotated-text` span from the HTML content.
         * @param {string} annotationIdToDelete The ID of the annotation to delete.
         */
        function deleteAnnotation(annotationIdToDelete) {
            const moduleIndex = dataModules.findIndex(m => m.id === selectedModuleId);
            if (moduleIndex === -1) {
                displayTemporaryMessage('Error: Selected module not found.', 'error');
                return;
            }

            const moduleToUpdate = dataModules[moduleIndex];
            const originalAnnotationCount = moduleToUpdate.annotations ? moduleToUpdate.annotations.length : 0;

            // Filter out the annotation from the data model
            moduleToUpdate.annotations = moduleToUpdate.annotations ?
                moduleToUpdate.annotations.filter(a => a.id !== annotationIdToDelete) : [];

            if (moduleToUpdate.annotations.length === originalAnnotationCount) {
                displayTemporaryMessage('Annotation not found to delete.', 'info');
                return;
            }

            // Remove the corresponding HTML span from the displayed content
            const annotatedSpan = contentDisplay.querySelector(`span.annotated-text[data-annotation-id="${annotationIdToDelete}"]`);
            if (annotatedSpan) {
                // Replace the span with its inner HTML content
                annotatedSpan.outerHTML = annotatedSpan.innerHTML;
            }

            // Update the module's HTML content from the modified DOM
            moduleToUpdate.content = contentDisplay.querySelector('#readableContent').innerHTML;

            // Re-convert to XML and save
            moduleToUpdate.xmlContent = convertHtmlToSimpleXml(moduleToUpdate.content);
            saveModules();
            addHistoryEntry('annotate', moduleToUpdate.id, moduleToUpdate.title, `Deleted annotation from content of "${moduleToUpdate.title}".`);
            displayTemporaryMessage('Annotation deleted.', 'success');
            renderContent(selectedModuleId); // Re-render to ensure all highlights are correct
        }


        // --- Full History Modal Functions ---
        /**
         * Opens the full history modal and displays all recorded actions.
         */
        function openFullHistoryModal() {
            fullHistoryModal.classList.remove('hidden');
            renderHistoryList(); // Initial render of history
            historySearchInput.value = ''; // Clear search
            historyFilterSelect.value = 'all'; // Reset filter
        }

        /**
         * Renders the history list based on current search and filter criteria.
         */
        function renderHistoryList() {
            const searchTerm = historySearchInput.value.toLowerCase();
            const filterType = historyFilterSelect.value;

            const filteredHistory = appHistory.filter(entry => {
                const matchesSearch = searchTerm === '' ||
                    entry.description.toLowerCase().includes(searchTerm) ||
                    entry.moduleTitle.toLowerCase().includes(searchTerm) ||
                    entry.user.toLowerCase().includes(searchTerm) ||
                    entry.action.toLowerCase().includes(searchTerm) ||
                    entry.timestamp.toLowerCase().includes(searchTerm);
                const matchesFilter = filterType === 'all' || entry.action === filterType;
                return matchesSearch && matchesFilter;
            });

            historyList.innerHTML = ''; // Clear existing list

            if (filteredHistory.length === 0) {
                noHistoryMessage.classList.remove('hidden');
            } else {
                noHistoryMessage.classList.add('hidden');
                filteredHistory.forEach(entry => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 mb-2 bg-white rounded-md shadow-sm border border-gray-100 flex flex-col';

                    let actionColorClass = 'text-gray-800';
                    if (entry.action === 'add') {
                        actionColorClass = 'text-green-700 font-semibold';
                    } else if (entry.action === 'edit') {
                        actionColorClass = 'text-blue-700 font-semibold';
                    } else if (entry.action === 'delete') {
                        actionColorClass = 'text-red-700 font-semibold';
                    } else if (entry.action === 'annotate') {
                        actionColorClass = 'text-purple-700 font-semibold';
                    }

                    listItem.innerHTML = `
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                            <span>${new Date(entry.timestamp).toLocaleString()}</span>
                            <span class="font-medium ${actionColorClass}">${entry.action.toUpperCase()}</span>
                        </div>
                        <p class="text-sm text-gray-800 font-medium mb-1">${entry.description}</p>
                        <span class="text-xs text-gray-600">By ${entry.user} (${entry.role})</span>
                    `;
                    historyList.appendChild(listItem);
                });
            }
        }


        // --- Event Listeners ---

        // Login form submission
        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (login(username, password)) {
                showAppScreen();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', logout);

        addModuleBtn.addEventListener('click', showAddModuleForm);
        cancelFormBtn.addEventListener('click', () => {
            moduleFormContainer.classList.add('hidden');
            contentDisplay.classList.remove('hidden'); // Show content display again
            if (selectedModuleId) {
                renderContent(selectedModuleId); // Re-render selected module content
            } else {
                contentDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-lg text-center p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open text-blue-400 mb-6"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <p class="text-xl font-medium text-gray-600">Welcome to your IETM Dashboard!</p>
                        <p class="mt-2 text-gray-500 max-w-prose">Select a data module from the sidebar on the left to view its content or manage it.</p>
                    </div>`;
            }
            renderModuleList(); // Re-render quick nav in case content display is empty
        });

        moduleForm.addEventListener('submit', saveModule);

        // Listen for changes on the parent topic select to toggle function topic name visibility
        parentTopicSelect.addEventListener('change', updateFunctionTopicNameVisibility);

        // --- Event Listeners for Current Module Admin Buttons ---
        editCurrentModuleBtn.addEventListener('click', () => {
            if (selectedModuleId) {
                editModule(selectedModuleId);
            }
        });

        deleteCurrentModuleBtn.addEventListener('click', () => {
            if (selectedModuleId) {
                const moduleTitle = dataModules.find(m => m.id === selectedModuleId)?.title;
                displayConfirmMessageBox(`Are you sure you want to delete this module ("${moduleTitle}") and its sub-topics?`, () => {
                    deleteModule(selectedModuleId);
                    displayTemporaryMessage("Module(s) deleted successfully!", 'success');
                }, () => {
                    displayTemporaryMessage("Deletion cancelled.", 'info');
                });
            }
        });

        downloadRawHtmlBtn.addEventListener('click', downloadRawHtml);
        downloadRawXmlBtn.addEventListener('click', downloadRawXml); // File System Access API save

        // --- Page Navigation Event Listeners ---
        backBtn.addEventListener('click', goBack);
        forwardBtn.addEventListener('click', goForward);
        refreshBtn.addEventListener('click', refreshCurrentModule);
        printBtn.addEventListener('click', printCurrentContent);
        downloadBtn.addEventListener('click', downloadCurrentContent); // Existing download for rendered HTML
        fullHistoryBtn.addEventListener('click', openFullHistoryModal); // Full History button


        // Quick Access Dropdown Listener
        quickAccessDropdown.addEventListener('change', (event) => {
            const moduleId = event.target.value;
            if (moduleId) {
                handleModuleSelect(moduleId);
            }
        });

        // Search Modules in Sidebar
        searchInput.addEventListener('input', (event) => {
            renderModuleList(event.target.value);
        });

        // Placeholder for chat and help functionality
        chatBtn.addEventListener('click', () => {
            displayTemporaryMessage('Chat functionality not yet implemented. Please refer to support.', 'info');
        });
        helpBtn.addEventListener('click', () => {
            displayTemporaryMessage('Help documentation is coming soon!', 'info');
        });

        // Image upload handling for primary image in admin form
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result; // Store Base64 string
                    imagePreview.src = currentImageBase64;
                    imagePreviewContainer.classList.remove('hidden');
                    openHotspotEditorBtn.disabled = false; // Enable hotspot button
                };
                reader.onerror = () => {
                    displayTemporaryMessage('Error reading image file.', 'error');
                    currentImageBase64 = null;
                    imagePreview.src = '';
                    imagePreviewContainer.classList.add('hidden');
                    openHotspotEditorBtn.disabled = true; // Disable hotspot button
                };
                reader.readAsDataURL(file);
            } else {
                currentImageBase64 = null;
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                openHotspotEditorBtn.disabled = true; // Disable hotspot button
                currentHotspots = []; // Clear hotspots if primary image is cleared
            }
        });

        clearImageBtn.addEventListener('click', () => {
            currentImageBase64 = null;
            imageUploadInput.value = ''; // Clear file input
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            openHotspotEditorBtn.disabled = true; // Disable hotspot button
            currentHotspots = []; // Clear hotspots if primary image is cleared
        });


        // Image Insertion Modal Logic
        insertImageBtn.addEventListener('click', () => {
            imageInsertModal.classList.remove('hidden');
        });

        closeImageInsertModal.addEventListener('click', () => {
            imageInsertModal.classList.add('hidden');
        });

        insertImageUrlBtn.addEventListener('click', () => {
            const imageUrl = prompt("Enter image URL:");
            if (imageUrl) {
                insertImageTagIntoContent(imageUrl, "External Image");
                displayTemporaryMessage('Image URL inserted into content.', 'success');
            } else {
                displayTemporaryMessage('No image URL provided.', 'info');
            }
            hideImageInsertModal();
        });

        uploadLocalImageBtn.addEventListener('click', () => {
            hiddenLocalImageInput.click(); // Trigger the hidden file input
        });

        // Hidden file input for local image upload
        hiddenLocalImageInput.addEventListener('change', (event) => {
            hideImageInsertModal(); // Hide modal after file selection
            const files = event.target.files;
            if (files.length > 0) {
                let filesProcessed = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        insertImageTagIntoContent(e.target.result, `Local Image ${i + 1}`);
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            displayTemporaryMessage(`${files.length} image(s) inserted into content.`, 'success');
                        }
                    };

                    reader.onerror = () => {
                        displayTemporaryMessage(`Error reading file: ${file.name}.`, 'error');
                        filesProcessed++; // Still count as processed even if error
                    };
                    reader.readAsDataURL(file); // Read file as Base64 data URL
                }
            } else {
                displayTemporaryMessage('No local images selected.', 'info');
            }
            hiddenLocalImageInput.value = ''; // Clear file input after processing
        });

        /**
         * Inserts an <img> tag into the module content textarea at the current cursor position.
         * @param {string} src The image source (URL or Base64 data URI).
         * @param {string} alt The alt text for the image.
         */
        function insertImageTagIntoContent(src, alt) {
            const textarea = moduleContentInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentContent = textarea.value;

            const imageTag = `<img src="${src}" alt="${alt}" style="max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">`;

            textarea.value = currentContent.substring(0, start) + imageTag + currentContent.substring(end);
            textarea.selectionStart = start + imageTag.length;
            textarea.selectionEnd = start + imageTag.length;
            textarea.focus();

            // Trigger XML conversion after inserting image
            updateXmlContent();
        }

        /**
         * Hides the image insertion modal.
         */
        function hideImageInsertModal() {
            imageInsertModal.classList.add('hidden');
        }

        // Hotspot Editor Button & Modal Listeners
        openHotspotEditorBtn.addEventListener('click', openHotspotEditor);
        closeHotspotEditorModal.addEventListener('click', cancelHotspotEditing);
        cancelHotspotsBtn.addEventListener('click', cancelHotspotEditing);
        saveHotspotsBtn.addEventListener('click', saveHotspotsToModule);
        addHotspotBtn.addEventListener('click', addCurrentHotspot);

        // Annotation Button & Modal Listeners
        // No direct "Annotate" button now, it's triggered by text selection (handleTextSelection)
        closeAnnotationModal.addEventListener('click', () => {
            annotationModal.classList.add('hidden');
            selectedRange = null; // Clear selected range
            window.getSelection().empty(); // Clear browser selection
        });
        cancelAnnotationBtn.addEventListener('click', () => {
            annotationModal.classList.add('hidden');
            selectedRange = null; // Clear selected range
            window.getSelection().empty(); // Clear browser selection
        });
        annotationForm.addEventListener('submit', saveAnnotation);

        // Full History Modal Listeners
        closeFullHistoryModal.addEventListener('click', () => fullHistoryModal.classList.add('hidden'));
        historySearchInput.addEventListener('input', renderHistoryList);
        historyFilterSelect.addEventListener('change', renderHistoryList);


        // --- Initial Load ---
        window.onload = initializeApp;
    </script>
</body>

</html>